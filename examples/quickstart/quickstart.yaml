AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  This template creates a BIG-IP Standalone WAF solution. The template uses nested
  templates for provisioning network, dag/ingress and compute resources for hosting
  BIG-IP Standalone solution.
Conditions:
  1nic: !Equals
    - 1
    - !Ref 'numNics'
  2nic: !Or
    - !Condition '3nic'
    - !Equals
      - 2
      - !Ref 'numNics'
  3nic: !Equals
    - 3
    - !Ref 'numNics'
  2nicPublic: !And
    - !Condition '2nic'
    - !Condition 'publicIp'
  1nicPublic: !And
    - !Condition '1nic'
    - !Condition 'publicIp'
  noPublicIp: !Equals
    - 'false'
    - !Ref 'provisionPublicIp'
  publicIp: !Equals
    - 'true'
    - !Ref 'provisionPublicIp'
  isPaygLicensing: !Equals
    - payg
    - !Ref 'licenseType'
  noCustomImageId: !Equals
    - ''
    - !Ref 'bigIpCustomImageId'
  useBigIpInstanceProfile: !Not
    - !Equals
      - !Ref 'bigIpInstanceProfile'
      - ""
  createKeyPair: !Equals
    - ''
    - !Ref 'sshKey'
  createSecret: !And
    - !Equals
      - !Ref 'provisionSecret'
      - 'true'
    - !Equals
      - ''
      - !Ref 'bigIpSecretArn'
  useSecretArn: !Not
    - !Equals
      - ''
      - !Ref 'bigIpSecretArn'
  useSecret: !And
    - !Or
      - !Condition 'createSecret'
      - !Condition 'useSecretArn'
    - !Not
      - !Condition 'useBigIpInstanceProfile'
  useAccess: !Or
    - !Condition 'createKeyPair'
    - !Condition 'useSecret'
Mappings:
  AWSBigipThroughput:
    1000Mbps:
      AdvancedWaf: AdvancedWaf1000Mbps
      Best: Best1000Mbps
      PerAppVeAwaf: PerAppVeAwaf1000Mbps
    200Mbps:
      AdvancedWaf: AdvancedWaf200Mbps
      Best: Best200Mbps
      PerAppVeAwaf: PerAppVeAwaf200Mbps
    25Mbps:
      AdvancedWaf: AdvancedWaf25Mbps
      Best: Best25Mbps
      PerAppVeAwaf: PerAppVeAwaf25Mbps
    5000Mbps:
      Best: Best5000Mbps
    10000Mbps:
      Best: Best10000Mbps
  VERSION:
    16-1-3-3-003:
      REGIONMAP: TMOS16133003
    14-1-5-3-005:
      REGIONMAP: TMOS14153005
  TMOS16133003:
    af-south-1:
      AdvancedWaf200Mbps: ami-070f1a1fea1b9777d
      AdvancedWaf25Mbps: ami-06db47e500e495705
      AdvancedWaf3000Mbps: ami-0477aa8717a278c8e
      AllTwoBootLocations: ami-0389d429fd6e6da75
      Best10000Mbps: ami-0d10a5bb4de5a43e7
      Best1000Mbps: ami-04d6c340d5a47b5f2
      Best200Mbps: ami-03332898156d6d3b0
      Best25Mbps: ami-05439b4f901538378
      Best5000Mbps: ami-0c52dcc16b5c22660
    ap-east-1:
      AdvancedWaf200Mbps: ami-0d4cc05bba9442811
      AdvancedWaf25Mbps: ami-0b312d2819df85a34
      AdvancedWaf3000Mbps: ami-01b818c49f9d77718
      AllTwoBootLocations: ami-0dced9cb298df2fc5
      Best10000Mbps: ami-086a73a18a9c27ba8
      Best1000Mbps: ami-0b0e119f85a21c08a
      Best200Mbps: ami-03d3a875f6a6033dd
      Best25Mbps: ami-0edf345aa33e6ed99
      Best5000Mbps: ami-02515a02ea2fe623a
    ap-northeast-1:
      AdvancedWaf200Mbps: ami-0712dc07e69253d2e
      AdvancedWaf25Mbps: ami-003710c8f57fadc37
      AdvancedWaf3000Mbps: ami-0d22d4b8d570e48fd
      AllTwoBootLocations: ami-0b997255a8403f24e
      Best10000Mbps: ami-06abd15e279ded339
      Best1000Mbps: ami-043c399b6eaf097c2
      Best200Mbps: ami-0d418e2f7b1f5451c
      Best25Mbps: ami-0a513498a5f6c72eb
      Best5000Mbps: ami-001715861ae73c66a
    ap-northeast-2:
      AdvancedWaf200Mbps: ami-0f360d6ca24186b9c
      AdvancedWaf25Mbps: ami-005d1524f1a5ebba9
      AdvancedWaf3000Mbps: ami-0f2149f8a50b30857
      AllTwoBootLocations: ami-01e721f12ae7f976f
      Best10000Mbps: ami-0167d6d016db04113
      Best1000Mbps: ami-08e2e8f114115a5bd
      Best200Mbps: ami-0ba826fb20912afdd
      Best25Mbps: ami-0caf11b8de1714a82
      Best5000Mbps: ami-0c1f6bdaa98a70c93
    ap-northeast-3:
      AdvancedWaf200Mbps: ami-0a5c692e5907abfb8
      AdvancedWaf25Mbps: ami-0757fbb73c2c33e08
      AdvancedWaf3000Mbps: ami-00b107369a4779b9e
      AllTwoBootLocations: ami-006253035126eab1a
      Best10000Mbps: ami-0408abd05304dd653
      Best1000Mbps: ami-0474f74857aeb7855
      Best200Mbps: ami-012b91cea669a50fa
      Best25Mbps: ami-0c3064dc5281efd26
      Best5000Mbps: ami-03a15e50ff42d68c9
    ap-south-1:
      AdvancedWaf200Mbps: ami-062b3427aefa71537
      AdvancedWaf25Mbps: ami-090966dde9d503364
      AdvancedWaf3000Mbps: ami-024a88912c25b5106
      AllTwoBootLocations: ami-0792b496db3b9ad2b
      Best10000Mbps: ami-002d7788f657b4b5f
      Best1000Mbps: ami-007087828280a3a54
      Best200Mbps: ami-04518dcc924e9fe39
      Best25Mbps: ami-065113dfe943167a6
      Best5000Mbps: ami-0f44975030b5ce1fd
    ap-southeast-1:
      AdvancedWaf200Mbps: ami-02126b28fc7bcc913
      AdvancedWaf25Mbps: ami-0b6e730f82b00e771
      AdvancedWaf3000Mbps: ami-0aed05a5843deaa05
      AllTwoBootLocations: ami-0f1b1e0bdc0b9714b
      Best10000Mbps: ami-0547ae308bf7400a8
      Best1000Mbps: ami-05568981ab4127f23
      Best200Mbps: ami-0032844743e8d5f79
      Best25Mbps: ami-07163e9a56596e00b
      Best5000Mbps: ami-0b334e70308af892c
    ap-southeast-2:
      AdvancedWaf200Mbps: ami-0f6e30ee1c3f38b8b
      AdvancedWaf25Mbps: ami-011957d5192f37e72
      AdvancedWaf3000Mbps: ami-0142b7cff0f15b1aa
      AllTwoBootLocations: ami-0d674b0f4e7d11171
      Best10000Mbps: ami-078bd0a228e421cb7
      Best1000Mbps: ami-04ed02f9a3e3d15ee
      Best200Mbps: ami-0e41ae3a973ad9304
      Best25Mbps: ami-02b2292710355a406
      Best5000Mbps: ami-09456381e33139543
    ca-central-1:
      AdvancedWaf200Mbps: ami-05196bdf946cbaef2
      AdvancedWaf25Mbps: ami-0556b8fc7d51a810d
      AdvancedWaf3000Mbps: ami-0e44410938d52363f
      AllTwoBootLocations: ami-0495a0ea4e8e728c2
      Best10000Mbps: ami-00dcfb4a064be93c0
      Best1000Mbps: ami-04ec646f8c1b8ea86
      Best200Mbps: ami-0761572a77193af7f
      Best25Mbps: ami-0038e22360a0c5832
      Best5000Mbps: ami-04fe500206eeca546
    eu-central-1:
      AdvancedWaf200Mbps: ami-02abcb1e6317c72af
      AdvancedWaf25Mbps: ami-0171cd5b6e3e8792d
      AdvancedWaf3000Mbps: ami-0bab1074127df65ea
      AllTwoBootLocations: ami-0eb34fa66458d36c0
      Best10000Mbps: ami-0b4e5302513521043
      Best1000Mbps: ami-098bacae7d7f40f96
      Best200Mbps: ami-00d987a8b4df5ea6e
      Best25Mbps: ami-08aa3b6b2fa2acdad
      Best5000Mbps: ami-0f9eaa8fa28f80361
    eu-north-1:
      AdvancedWaf200Mbps: ami-0bb351dbe87b2c177
      AdvancedWaf25Mbps: ami-033eeb51a1c37b769
      AdvancedWaf3000Mbps: ami-0e430cc4bbf0b295e
      AllTwoBootLocations: ami-0d55dc320a9c7965c
      Best10000Mbps: ami-0ceeeccc3b48ae01c
      Best1000Mbps: ami-06ab37fff48ba8d82
      Best200Mbps: ami-06606b4741ce83093
      Best25Mbps: ami-0036801cdc2aae460
      Best5000Mbps: ami-04bdec371ebbbd17a
    eu-south-1:
      AdvancedWaf200Mbps: ami-019bd56ffda3ce2f0
      AdvancedWaf25Mbps: ami-004f712702aa9d840
      AdvancedWaf3000Mbps: ami-03139909602c7e579
      AllTwoBootLocations: ami-005780e8784783c11
      Best10000Mbps: ami-0fd7b3f9e0a8a8a52
      Best1000Mbps: ami-0718b95e5def151c0
      Best200Mbps: ami-06240dddce6464063
      Best25Mbps: ami-055463560f7f6b4dd
      Best5000Mbps: ami-09746094e65cbfe26
    eu-west-1:
      AdvancedWaf200Mbps: ami-06fdd253072726e0b
      AdvancedWaf25Mbps: ami-01c12bc2c9e2c2df4
      AdvancedWaf3000Mbps: ami-0a533e90eb6e07753
      AllTwoBootLocations: ami-0010007114b96b8de
      Best10000Mbps: ami-058b7289b92246841
      Best1000Mbps: ami-0b9924287f5813815
      Best200Mbps: ami-0875f7ae53ff8c7c8
      Best25Mbps: ami-05fe9d55e3eddfe4d
      Best5000Mbps: ami-0fad6cee1e7259dd9
    eu-west-2:
      AdvancedWaf200Mbps: ami-0a92ac240a396d391
      AdvancedWaf25Mbps: ami-05e60d09985c6558f
      AdvancedWaf3000Mbps: ami-029b312d7725a71d9
      AllTwoBootLocations: ami-004454650f4c0f0bf
      Best10000Mbps: ami-091fb528b9f577d52
      Best1000Mbps: ami-07b0a9b74703cd0bd
      Best200Mbps: ami-0c8b4a3be60a088db
      Best25Mbps: ami-09aaf20bf41c4406c
      Best5000Mbps: ami-0b59ec60ff6c4c68a
    eu-west-3:
      AdvancedWaf200Mbps: ami-06f8b48fe6737578a
      AdvancedWaf25Mbps: ami-0d4f249f34034e9f9
      AdvancedWaf3000Mbps: ami-09ff8a33418d21a63
      AllTwoBootLocations: ami-0997c7acca71528ff
      Best10000Mbps: ami-09fc6139bfc135cda
      Best1000Mbps: ami-0ca06a78d08941f32
      Best200Mbps: ami-0ad95a3570b17995a
      Best25Mbps: ami-06046941961bf2064
      Best5000Mbps: ami-0396b4e8cbdaa325b
    me-south-1:
      AdvancedWaf200Mbps: ami-0aedf53d5332a8b91
      AdvancedWaf25Mbps: ami-0cbf8867bf8199c22
      AdvancedWaf3000Mbps: ami-03bea04d72197d392
      AllTwoBootLocations: ami-034069a9ac53b3a3b
      Best10000Mbps: ami-08bf5d28c40403a15
      Best1000Mbps: ami-08259c0e102f1c106
      Best200Mbps: ami-0a983104d6a649856
      Best25Mbps: ami-09b16dff7299868af
      Best5000Mbps: ami-0d6033cea15edffe7
    sa-east-1:
      AdvancedWaf200Mbps: ami-09a84ec7a00894773
      AdvancedWaf25Mbps: ami-042c884ab9371628e
      AdvancedWaf3000Mbps: ami-045ec55c4a7c62355
      AllTwoBootLocations: ami-06347f9b1f5c46911
      Best10000Mbps: ami-0dd998fc1e17b0817
      Best1000Mbps: ami-0551322023a1720df
      Best200Mbps: ami-0b14c073bfa34f7e6
      Best25Mbps: ami-0cb1a94adfdad321f
      Best5000Mbps: ami-0e20339cc98cb71a8
    us-east-1:
      AdvancedWaf200Mbps: ami-005bc7b8a626a77c0
      AdvancedWaf25Mbps: ami-0be5f6d3cd2af8ffe
      AdvancedWaf3000Mbps: ami-0f3c4dbe787dc61cd
      AllTwoBootLocations: ami-0d500f8c9aad3913d
      Best10000Mbps: ami-0b106df253be770d6
      Best1000Mbps: ami-0c9fbe5643df17e44
      Best200Mbps: ami-05e88b5e0fe482d30
      Best25Mbps: ami-041ae549e4ada56b1
      Best5000Mbps: ami-0d1d3f05e8d1f0cff
    us-east-2:
      AdvancedWaf200Mbps: ami-01a50399dcc2ea03e
      AdvancedWaf25Mbps: ami-022027c63b7e67eba
      AdvancedWaf3000Mbps: ami-06edaaf65ff3d4c38
      AllTwoBootLocations: ami-0726e773e8271b122
      Best10000Mbps: ami-0ec05d14e00e27ef0
      Best1000Mbps: ami-05cb065f22f1372ba
      Best200Mbps: ami-0abea1f8c456d2836
      Best25Mbps: ami-0d97ddbbbfcc2400a
      Best5000Mbps: ami-0911c9998c0cca9a0
    us-west-1:
      AdvancedWaf200Mbps: ami-020c2cf0635c2da2e
      AdvancedWaf25Mbps: ami-079e4151fff2a688f
      AdvancedWaf3000Mbps: ami-047d0245b0c061ec8
      AllTwoBootLocations: ami-0c66d66ec164873a3
      Best10000Mbps: ami-00da91f2e7c0fa317
      Best1000Mbps: ami-0929b63fb95378721
      Best200Mbps: ami-0f311998221ffb570
      Best25Mbps: ami-0ca078ae217ecb1ef
      Best5000Mbps: ami-0138c0d7c86e9dbef
    us-west-2:
      AdvancedWaf200Mbps: ami-0ad4a9823b5db8d1e
      AdvancedWaf25Mbps: ami-0e7588ac353b61db9
      AdvancedWaf3000Mbps: ami-0f31f19dc2a186b88
      AllTwoBootLocations: ami-0712c12f459a9fea5
      Best10000Mbps: ami-0bab30ab1428aa069
      Best1000Mbps: ami-07f3f2ce6a7525bf3
      Best200Mbps: ami-051c2ed71aef463f3
      Best25Mbps: ami-0bd5efbcfbfabc942
      Best5000Mbps: ami-0102d124b40d9bd23
    us-gov-west-1:
      AdvancedWaf200Mbps: ami-03b81ab076fec7d67
      AdvancedWaf25Mbps: ami-0cb8404383786a549
      AdvancedWaf3000Mbps: ami-0dd0e753d3cc35369
      AllTwoBootLocations: ami-0f99c5a1f854fb776
      Best10000Mbps: ami-090c25f464bb6d23a
      Best1000Mbps: ami-0fca55cfe7e1ed032
      Best200Mbps: ami-0ff1e25fee9c8191e
      Best25Mbps: ami-071c6317ab2631d73
      Best5000Mbps: ami-0835ef6aa4f4a9b8e
    us-gov-east-1:
      AdvancedWaf200Mbps: ami-0222a5e756d69ca90
      AdvancedWaf25Mbps: ami-0abb0d1d350157d31
      AdvancedWaf3000Mbps: ami-0feb6128c5e40fe91
      AllTwoBootLocations: ami-0abcfcd4c2bd42318
      Best10000Mbps: ami-035ce4d2aea9c68af
      Best1000Mbps: ami-0bf47a3c614457a07
      Best200Mbps: ami-04008199bda311434
      Best25Mbps: ami-0afd61aecc9c7ec4a
      Best5000Mbps: ami-037809a9a41297f4c
  TMOS14153005:
    af-south-1:
      AdvancedWaf200Mbps: ami-09d42a1179edd3816
      AdvancedWaf25Mbps: ami-088b6b2c03949bd8b
      AdvancedWaf3000Mbps: ami-0ce8a69e5e02d041b
      AllTwoBootLocations: ami-0ce11e39bcd97cd9f
      Best10000Mbps: ami-0011f5dc768feb1c7
      Best1000Mbps: ami-0500f7d06470b8e65
      Best200Mbps: ami-0e38fde853cd4f292
      Best25Mbps: ami-08ea109ff80a449a7
      Best5000Mbps: ami-0f3e8f132a798c881
    ap-east-1:
      AdvancedWaf200Mbps: ami-018000572f401b2ff
      AdvancedWaf25Mbps: ami-05a36160f873db80c
      AdvancedWaf3000Mbps: ami-099cfcb84a557599c
      AllTwoBootLocations: ami-0fc914e39e9b7a303
      Best10000Mbps: ami-05276c7f87f1a39cc
      Best1000Mbps: ami-00800fb65f51c6c7b
      Best200Mbps: ami-04a16decd3d0e20ba
      Best25Mbps: ami-073e7b7a95e2608dd
      Best5000Mbps: ami-0d90e398659213608
    ap-northeast-1:
      AdvancedWaf200Mbps: ami-088ae58f61563b1c1
      AdvancedWaf25Mbps: ami-09b117b5c8c5ab268
      AdvancedWaf3000Mbps: ami-02be18995d701b6a9
      AllTwoBootLocations: ami-0e358e7d02261e616
      Best10000Mbps: ami-0f5e95a14dc039ece
      Best1000Mbps: ami-063920a48d6495f18
      Best200Mbps: ami-0fa1e22d9156998f4
      Best25Mbps: ami-0751b8ee6a026252f
      Best5000Mbps: ami-086c370dd433b711d
    ap-northeast-2:
      AdvancedWaf200Mbps: ami-0b116020e4fcd66b7
      AdvancedWaf25Mbps: ami-00efe8e892321547e
      AdvancedWaf3000Mbps: ami-0253983833393f066
      AllTwoBootLocations: ami-01eb6618645ec811a
      Best10000Mbps: ami-09f01a0131a7987bd
      Best1000Mbps: ami-010e4701039dadff7
      Best200Mbps: ami-0349176d4b26cb939
      Best25Mbps: ami-0f04eb4184af5844c
      Best5000Mbps: ami-0326536cf517104a0
    ap-northeast-3:
      AdvancedWaf200Mbps: ami-01a8c7553238e1b91
      AdvancedWaf25Mbps: ami-0db50d1ebb57d3d1f
      AdvancedWaf3000Mbps: ami-0e796b09bfba5ada3
      AllTwoBootLocations: ami-0b1e7baa59c1205f2
      Best10000Mbps: ami-062bece221a6e55ff
      Best1000Mbps: ami-0fc6cb19306aa83a5
      Best200Mbps: ami-04cce9f5beeabb358
      Best25Mbps: ami-0687fbb6c8b9b999a
      Best5000Mbps: ami-0100cbe0606b15240
    ap-south-1:
      AdvancedWaf200Mbps: ami-05a779473b03450f4
      AdvancedWaf25Mbps: ami-00b2f11deb61c3f9d
      AdvancedWaf3000Mbps: ami-0628ad63de9ba0e15
      AllTwoBootLocations: ami-0fb24df24f3b7c320
      Best10000Mbps: ami-03605d332d1a1e7ab
      Best1000Mbps: ami-0b62bac2864b0ce8a
      Best200Mbps: ami-0c011ec0a8bc5c7c6
      Best25Mbps: ami-0bda59badbe1bdaa7
      Best5000Mbps: ami-0172241e91cc466ad
    ap-southeast-1:
      AdvancedWaf200Mbps: ami-03a43c275ba3a1490
      AdvancedWaf25Mbps: ami-0c4be398b959ea19a
      AdvancedWaf3000Mbps: ami-0a2b161009a7f2db0
      AllTwoBootLocations: ami-049dd1850cfd71e7f
      Best10000Mbps: ami-0df7bbe29278a21fd
      Best1000Mbps: ami-08f97862b536244bb
      Best200Mbps: ami-0cf39ccb0a162802b
      Best25Mbps: ami-0adcff01f9cbcc0ae
      Best5000Mbps: ami-0838bec7022be6288
    ap-southeast-2:
      AdvancedWaf200Mbps: ami-0d7e313d89cff2156
      AdvancedWaf25Mbps: ami-09e321c5a4ce32a24
      AdvancedWaf3000Mbps: ami-0c12dbd50ccacacae
      AllTwoBootLocations: ami-0719feb6f1f45de04
      Best10000Mbps: ami-0884ef21dc3eaa507
      Best1000Mbps: ami-068ca0f130cb402c3
      Best200Mbps: ami-09c682b3db24a3b45
      Best25Mbps: ami-049d8a03d6c77e7ce
      Best5000Mbps: ami-048dac1a2f2dde3b9
    ca-central-1:
      AdvancedWaf200Mbps: ami-0ae1bf8c937e0d062
      AdvancedWaf25Mbps: ami-02ee3bf1e28568568
      AdvancedWaf3000Mbps: ami-06cdca239c2b50341
      AllTwoBootLocations: ami-0e6e1cc64c904e093
      Best10000Mbps: ami-0096757597566b8d3
      Best1000Mbps: ami-0c7299eda6316c708
      Best200Mbps: ami-0a8b4ced41bc92862
      Best25Mbps: ami-08716a6753fcc3fdd
      Best5000Mbps: ami-01209de4cac369248
    eu-central-1:
      AdvancedWaf200Mbps: ami-0cb5108f1ecd4f83d
      AdvancedWaf25Mbps: ami-0054b4c5cb64c0035
      AdvancedWaf3000Mbps: ami-0f455c59791bdaaea
      AllTwoBootLocations: ami-00e577a7c723a2584
      Best10000Mbps: ami-0e1e5e54552fa6d7e
      Best1000Mbps: ami-05c3bacf92ec25f29
      Best200Mbps: ami-080a307f74062ba86
      Best25Mbps: ami-0ca6c3430728cfe9e
      Best5000Mbps: ami-0d0964f6cbaeb534c
    eu-north-1:
      AdvancedWaf200Mbps: ami-0ca8fd032ed3cfc4c
      AdvancedWaf25Mbps: ami-02558502aa4e8bb79
      AdvancedWaf3000Mbps: ami-01c05bedceeef1409
      AllTwoBootLocations: ami-051ee10f6044b818f
      Best10000Mbps: ami-04bf451b0e39f840b
      Best1000Mbps: ami-079c89b1989969823
      Best200Mbps: ami-027ad58663f06cf0c
      Best25Mbps: ami-06e3a80def42feb11
      Best5000Mbps: ami-0f78b44f5b7f4972f
    eu-south-1:
      AdvancedWaf200Mbps: ami-06556ec2716f79040
      AdvancedWaf25Mbps: ami-0f81024ed7165b05a
      AdvancedWaf3000Mbps: ami-0fbac20d156258a99
      AllTwoBootLocations: ami-0d43d9c88f0beaba4
      Best10000Mbps: ami-0f1a78bd9d5063b42
      Best1000Mbps: ami-0ac17d206072f3f49
      Best200Mbps: ami-0484bf59f117b8458
      Best25Mbps: ami-0a6159dfb258e8c7e
      Best5000Mbps: ami-0d17d96cef823db47
    eu-west-1:
      AdvancedWaf200Mbps: ami-0990d0bb4ad3f00b5
      AdvancedWaf25Mbps: ami-0e9596f7bb67e4eed
      AdvancedWaf3000Mbps: ami-09fdecd7047d10f36
      AllTwoBootLocations: ami-0b425a39447fc0aa8
      Best10000Mbps: ami-01fbc19395097c436
      Best1000Mbps: ami-0ad4935bdad3cfd75
      Best200Mbps: ami-0b433c74f3f8f5452
      Best25Mbps: ami-002731a9033c3cb15
      Best5000Mbps: ami-04e6fb9a4fc9ae422
    eu-west-2:
      AdvancedWaf200Mbps: ami-05e64ca384076e2df
      AdvancedWaf25Mbps: ami-0efd84d8fb6cac4e7
      AdvancedWaf3000Mbps: ami-0ec663758b486a51c
      AllTwoBootLocations: ami-0b3d88b2abe98e279
      Best10000Mbps: ami-07a3ee4d69268d0b8
      Best1000Mbps: ami-021daf37817cdcd57
      Best200Mbps: ami-04f51a5e6acd853fb
      Best25Mbps: ami-0f02fa5a46f192c05
      Best5000Mbps: ami-09581c887f51474f0
    eu-west-3:
      AdvancedWaf200Mbps: ami-0162c8d76afd75a71
      AdvancedWaf25Mbps: ami-078f713f49aa24d89
      AdvancedWaf3000Mbps: ami-07757e6fdf1c38734
      AllTwoBootLocations: ami-0c09152f7a27a5e3d
      Best10000Mbps: ami-06c4e087c53332cb1
      Best1000Mbps: ami-0e8b01b1b846fe315
      Best200Mbps: ami-024603af967b19b64
      Best25Mbps: ami-05e4558a737873d57
      Best5000Mbps: ami-0e333563b3a45307b
    me-south-1:
      AdvancedWaf200Mbps: ami-087a1ca0995b474dd
      AdvancedWaf25Mbps: ami-02a099323eb475695
      AdvancedWaf3000Mbps: ami-0a0e84a5f8f7bf2d3
      AllTwoBootLocations: ami-0c6a340e017ee1bfa
      Best10000Mbps: ami-029815229c15c6c5d
      Best1000Mbps: ami-0c33eec3dc9eec377
      Best200Mbps: ami-01e10152ddb1595de
      Best25Mbps: ami-01a868a7adf866328
      Best5000Mbps: ami-0121c5f5e8a4545d6
    sa-east-1:
      AdvancedWaf200Mbps: ami-0b8cf5b3848e92bf9
      AdvancedWaf25Mbps: ami-0f142b653e7e6c0f5
      AdvancedWaf3000Mbps: ami-020c81b22078119bd
      AllTwoBootLocations: ami-0e41b54602abfe20b
      Best10000Mbps: ami-03f91f4ce8b77a99a
      Best1000Mbps: ami-08aba378fdf6d2e24
      Best200Mbps: ami-059d432ed06baee7f
      Best25Mbps: ami-0fcbbc4f8eb73662c
      Best5000Mbps: ami-034f34aafc69e7a91
    us-east-1:
      AdvancedWaf200Mbps: ami-0b3442cdb849413bf
      AdvancedWaf25Mbps: ami-04c17b4263c7103a4
      AdvancedWaf3000Mbps: ami-03ca33d2a7c57c981
      AllTwoBootLocations: ami-083a01b1c1f36af9c
      Best10000Mbps: ami-019e0c102fe26f99a
      Best1000Mbps: ami-0efa7efac4da920d0
      Best200Mbps: ami-08e0a89360cce8b3a
      Best25Mbps: ami-04090ea7c0b10b56a
      Best5000Mbps: ami-0a97a2f4fd9e30089
    us-east-2:
      AdvancedWaf200Mbps: ami-00931fd54ec28b684
      AdvancedWaf25Mbps: ami-033780a3c06bd731c
      AdvancedWaf3000Mbps: ami-0a4d3e4ad0e9788ca
      AllTwoBootLocations: ami-064265572b64875ca
      Best10000Mbps: ami-0f17862b5e085e136
      Best1000Mbps: ami-053678f205580548d
      Best200Mbps: ami-0c731b0efdda9464c
      Best25Mbps: ami-09de98757638c45ac
      Best5000Mbps: ami-0d4f7892b9dbbe6f5
    us-west-1:
      AdvancedWaf200Mbps: ami-0a1d276f68687df02
      AdvancedWaf25Mbps: ami-09c9bd7934fef59d1
      AdvancedWaf3000Mbps: ami-0325e34d7f028c903
      AllTwoBootLocations: ami-0726d69d2b50af5c4
      Best10000Mbps: ami-0f883c414410bd336
      Best1000Mbps: ami-05f45688a31221a50
      Best200Mbps: ami-05712e61faa7eae0e
      Best25Mbps: ami-0eb3c84741bc873dd
      Best5000Mbps: ami-04a8bdc70cb18cdb2
    us-west-2:
      AdvancedWaf200Mbps: ami-0c20bd6924ddb8277
      AdvancedWaf25Mbps: ami-0c3d8bf3a2440bcd4
      AdvancedWaf3000Mbps: ami-0e2e387980bb170dd
      AllTwoBootLocations: ami-09561c46c53a98051
      Best10000Mbps: ami-098e3a7b89541fc19
      Best1000Mbps: ami-01bace4ff96ee82eb
      Best200Mbps: ami-008b24ca66cd54b70
      Best25Mbps: ami-029a74008d86dc827
      Best5000Mbps: ami-06eaaef6d44a3418c
    us-gov-west-1:
      AdvancedWaf200Mbps: ami-02e21360c5d57336a
      AdvancedWaf25Mbps: ami-05bd36f9d89d528a9
      AdvancedWaf3000Mbps: ami-0b8d6cb6e4865bf66
      AllTwoBootLocations: ami-0169780adf8496132
      Best10000Mbps: ami-074260bf680a4fe40
      Best1000Mbps: ami-08e06a21f8e481262
      Best200Mbps: ami-074f8343468bdb020
      Best25Mbps: ami-06c4130e0c7a1accb
      Best5000Mbps: ami-0a4d5041b69f585d9
    us-gov-east-1:
      AdvancedWaf200Mbps: ami-06e5de7f76a71d1b9
      AdvancedWaf25Mbps: ami-034155c53ae1bca7c
      AdvancedWaf3000Mbps: ami-0c536d7b0897323fe
      AllTwoBootLocations: ami-01346ea9f903eb05c
      Best10000Mbps: ami-0d12ebceb39684a4c
      Best1000Mbps: ami-0ba410545e72d18aa
      Best200Mbps: ami-04ba3f6a3feb118cd
      Best25Mbps: ami-0e61493659ddd2c12
      Best5000Mbps: ami-03f744c933821e3bb
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Templates Location
        Parameters:
          - s3BucketRegion
          - s3BucketName
          - artifactLocation
      - Label:
          default: Network Configuration
        Parameters:
          - numAzs
          - numSubnets
      - Label:
          default: Amazon EC2 Configuration
        Parameters:
          - sshKey
          - restrictedSrcAddressMgmt
          - restrictedSrcAddressApp
          - bigIpInstanceProfile
      - Label:
          default: BIG-IP Configuration
        Parameters:
          - version
          - licenseType
          - bigIpImage
          - throughput
          - bigIpCustomImageId
          - bigIpInstanceType
          - numNics
          - bigIpRuntimeInitConfig
          - bigIpRuntimeInitPackageUrl
          - bigIpHostname
          - bigIpLicenseKey
          - provisionPublicIp
          - provisionSecret
          - bigIpSecretArn
          - allowUsageAnalytics
      - Label:
          default: Application Configuration
        Parameters:
          - appContainerName
      - Label:
          default: Resources Tags
        Parameters:
          - uniqueString
          - application
          - cost
          - environment
          - group
          - owner
    ParameterLabels:
      allowUsageAnalytics:
        default: Send anonymous statistics to F5
      appContainerName:
        default: Docker Image Name
      application:
        default: Application
      artifactLocation:
        default: Directory Path
      bigIpCustomImageId:
        default: Custom Image Id
      bigIpHostname:
        default: Hostname for BIG-IP instance
      bigIpImage:
        default: F5 BIG-IP Performance Type (PAYG Only)
      bigIpInstanceProfile:
        default: Instance profile
      bigIpInstanceType:
        default: Instance Type
      bigIpLicenseKey:
        default: License key for BIG-IP instance
      bigIpRuntimeInitConfig:
        default: BIG-IP Runtime Init Config
      bigIpRuntimeInitPackageUrl:
        default: Runtime Init Package
      bigIpSecretArn:
        default: ARN of Secrets Manager secret
      cost:
        default: Cost Center
      provisionSecret:
        default: Creates Secrets Manager secret for BIG-IP password
      environment:
        default: Environment
      group:
        default: Group
      licenseType:
        default: License Type
      numAzs:
        default: Availability Zones
      numNics:
        default: Interfaces
      numSubnets:
        default: Subnets
      owner:
        default: Owner
      provisionPublicIp:
        default: Provision Public IP addresses for the BIG-IP management interface
      restrictedSrcAddressApp:
        default: Restricted source address to application
      restrictedSrcAddressMgmt:
        default: Restricted source address to BIG-IP
      s3BucketName:
        default: S3 Bucket
      s3BucketRegion:
        default: S3 Bucket Region
      sshKey:
        default: SSH public key
      throughput:
        default: BIG-IP VE throughput (PAYG Only)
      uniqueString:
        default: Unique String
      version:
        default: BIG-IP Version
  Version: 3.1.0.0
Outputs:
  bigIpInstanceId:
    Description: bigip's instance-id
    Value: !GetAtt [BigipStandalone, Outputs.bigIpInstanceId]
  bastionInstanceId:
    Condition: noPublicIp
    Description: bastion's instance-id
    Value: !GetAtt [Bastion, Outputs.bastionInstanceId]
  bastionPublicIp:
    Condition: noPublicIp
    Description: bastion's public IP address
    Value: !GetAtt [Bastion, Outputs.bastionPublicIp]
  bigIpKeyPairName:
    Condition: createKeyPair
    Description: SSH key pair name
    Value: !GetAtt [Access, Outputs.keyPairName]
  bigIpManagementPrivateIp:
    Description: bigip's private management address
    Value: !GetAtt [BigipStandalone, Outputs.bigIpManagementInterfacePrivateIp]
  bigIpManagementPublicIp:
    Condition: publicIp
    Description: bigip's public management address. WARNING - For eval purposes only.
      Production should never have the management interface exposed to Internet
    Value: !GetAtt [Dag, Outputs.bigIpManagementEipAddress01]
  bigIpManagementSsh:
    Condition: publicIp
    Description: ssh login to bigip's management address. WARNING - For eval purposes
      only. Production should never have the management interface exposed to Internet
    Value: !Join
      - ''
      - - 'ssh admin@'
        - !GetAtt [Dag, Outputs.bigIpManagementEipAddress01]
  bigIpManagementUrl443:
    Condition: 2nicPublic
    Description: url to bigip's management address. WARNING - For eval purposes only.
      Production should never have the management interface exposed to Internet
    Value: !Join
      - ''
      - - 'https://'
        - !GetAtt [Dag, Outputs.bigIpManagementEipAddress01]
  bigIpManagementUrl8443:
    Condition: 1nicPublic
    Description: url to bigip's management address. WARNING - For eval purposes only.
      Production should never have the management interface exposed to Internet
    Value: !Join
      - ''
      - - 'https://'
        - !GetAtt [Dag, Outputs.bigIpManagementEipAddress01]
        - ':8443'
  bigIpSecretArn:
    Condition: createSecret
    Description: Secret ARN
    Value: !GetAtt [Access, Outputs.secretArn]
  vipPublicUrl:
    Description: url to public vip address
    Value: !Join
      - ''
      - - 'https://'
        - !GetAtt [Dag, Outputs.bigIpExternalEipAddress02]
Parameters:
  allowUsageAnalytics:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: This deployment can send anonymous statistics to F5 to help us determine
      how to improve our solutions. If you select **false** statistics are not sent.
    Type: String
  appContainerName:
    Default: 'f5devcentral/f5-demo-app:latest'
    Description: Application docker image name
    Type: String
  application:
    Default: f5app
    Description: Application Tag.
    Type: String
  artifactLocation:
    AllowedPattern: ^.*[0-9a-zA-Z]+/$
    ConstraintDescription: 'key prefix can include numbers, lowercase letters, uppercase
      letters, hyphens (-), and forward slash (/).'
    Default: f5-aws-cloudformation-v2/v3.1.0.0/examples/
    Description: 'The path in the S3Bucket where the modules folder is located. Can
      include numbers, lowercase letters, uppercase letters, hyphens (-), and forward
      slash (/).'
    Type: String
  bigIpHostname:
    ConstraintDescription: Must be a valid hostname containing fewer than 63 characters.
    Default: 'bigip01.local'
    Description: Supply the hostname you would like to use for the BIG-IP instance.
      The hostname must contain fewer than 63 characters.
    MaxLength: 63
    Type: String
  bigIpLicenseKey:
    Default: ''
    Description: Supply the F5 BYOL license key for the BIG-IP instance. Leave this
      parameter blank if deploying the PAYG solution.
    Type: String
  bigIpRuntimeInitConfig:
    Default: 'https://f5-cft-v2.s3.amazonaws.com/f5-aws-cloudformation-v2/v3.1.0.0/examples/quickstart/bigip-configurations/runtime-init-conf-3nic-payg-with-app.yaml'
    Description: 'Supply a URL to the bigip-runtime-init configuration file in YAML
      or JSON format to use for f5-bigip-runtime-init configuration.'
    Type: String
  bigIpRuntimeInitPackageUrl:
    Default: 'https://cdn.f5.com/product/cloudsolutions/f5-bigip-runtime-init/v1.6.2/dist/f5-bigip-runtime-init-1.6.2-1.gz.run'
    Description: URL for BIG-IP Runtime Init package.
    Type: String
  bigIpSecretArn:
    Default: ''
    Description: The ARN of an existing AWS Secrets Manager secret where the BIG-IP
      password used for clustering is stored. If left empty, and provisionSecret is
      true, a secret will be created.
    Type: String
  cost:
    Default: f5costcenter
    Description: Cost Center Tag.
    Type: String
  bigIpCustomImageId:
    Default: ''
    Description: Provide BIG-IP AMI ID you wish to deploy.
    MaxLength: 255
    Type: String
  environment:
    Default: f5env
    Description: Environment Tag.
    Type: String
  group:
    Default: f5group
    Description: Group Tag.
    Type: String
  bigIpImage:
    AllowedValues:
      - Best
    ConstraintDescription: Must be a valid F5 BIG-IP VE image type
    Default: Best
    Description: F5 BIG-IP Performance Type
    Type: String
  bigIpInstanceProfile:
    Default: ''
    Description: Enter the name of an existing IAM instance profile with applied IAM
      policy to be associated to the BIG-IP virtual machine(s). Leave default if not
      using an instance profile.
    Type: String
  bigIpInstanceType:
    ConstraintDescription: Must be a valid EC2 instance type for BIG-IP
    Default: m5.2xlarge
    Description: Enter valid instance type.
    Type: String
  licenseType:
    AllowedValues:
      - payg
      - byol
    Default: payg
    Description: Specifies license type used for BIG-IP VE.
    Type: String
  numAzs:
    AllowedValues:
      - 1
      - 2
      - 3
      - 4
    Default: 1
    Description: Number of Availability Zones to use in the VPC. Region must support
      number of availability  zones entered. Min 1 Max 4.
    Type: Number
  numNics:
    AllowedValues:
      - 1
      - 2
      - 3
    Default: 3
    Description: Number of interfaces to create on BIG-IP instance. Maximum of 3 allowed.
      Minimum of 1 allowed.
    Type: Number
  numSubnets:
    AllowedValues:
      - 4
      - 5
      - 6
      - 7
      - 8
    Default: 4
    Description: Indicate the number of subnets to create.
    Type: Number
  owner:
    Default: f5owner
    Description: Owner Tag.
    Type: String
  provisionPublicIp:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: Whether or not to provision Public IP Addresses for the BIG-IP Network
      Interfaces.
    Type: String
  provisionSecret:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
    Description: Value of true creates AWS Secrets Manager secret.
    Type: String
  restrictedSrcAddressApp:
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x.
    Description: REQUIRED - The IP address range that can be used to access web traffic
      (80/443) to the EC2 instances.
    MaxLength: '18'
    MinLength: '9'
    Type: String
  restrictedSrcAddressMgmt:
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x.
    Description: REQUIRED - The IP address range used to SSH and access BIG-IP management
      port.  Restrict to your client IP. Ex. X.X.X.X/32. WARNING - For eval purposes
      only. Production should never have Management interface exposed to Internet.
    MaxLength: '18'
    MinLength: '9'
    Type: String
  s3BucketName:
    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
    ConstraintDescription: 'S3 bucket name can include numbers, lowercase letters,
      uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).'
    Description: 'REQUIRED - S3 bucket name for the modules. S3 bucket name can include
      numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start
      or end with a hyphen (-).'
    Default: f5-cft-v2
    Type: String
  s3BucketRegion:
    Default: us-east-1
    Description: 'The AWS Region where the Quick Start S3 bucket (s3BucketName) is
      hosted. When using your own bucket, you must specify this value.'
    Type: String
  sshKey:
    Default: ''
    Description: Supply the public key that will be used for SSH authentication to
      the BIG-IP, application, and bastion virtual machines. If left empty, one will
      be created.
    Type: String
  throughput:
    AllowedValues:
      - 25Mbps
      - 200Mbps
      - 1000Mbps
      - 5000Mbps
      - 10000Mbps
    ConstraintDescription: Select the BIG-IP throughput you want to use
    Default: 25Mbps
    Description: Maximum amount of throughput for BIG-IP VE.
    Type: String
  uniqueString:
    AllowedPattern: '^[a-z][a-z0-9]{1,11}$'
    ConstraintDescription: Must contain between 1 and 12 lowercase alphanumeric characters
      with first character as a letter.
    Default: myuniqstr
    Description: Unique String used when creating object names or Tags.
    Type: String
  version:
    AllowedValues:
      - 16-1-3-3-003
      - 14-1-5-3-005
    Default: 16-1-3-3-003
    Description: Select version of BIG-IP you wish to deploy.
    Type: String
Resources:
  Access:
    Type: 'AWS::CloudFormation::Stack'
    Condition: useAccess
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.amazonaws.com/${artifactLocation}modules/access/access.yaml'
        - S3Region: !Ref 's3BucketRegion'
          S3Bucket: !Ref 's3BucketName'
      Parameters:
        application: !Ref 'application'
        cost: !Ref 'cost'
        environment: !Ref 'environment'
        group: !Ref 'group'
        createBigIpRoles: !If [useSecret, 'true', 'false']
        createSecret: !If [createSecret, 'true', 'false']
        createSshKey: !If [createKeyPair, 'true', 'false']
        secretArn: !If [useSecretArn, !Ref 'bigIpSecretArn', !Ref 'AWS::NoValue']
        solutionType: !If [useSecret, 'secret', 'standard']
        uniqueString: !Ref 'uniqueString'
  Application:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.amazonaws.com/${artifactLocation}modules/application/application.yaml'
        - S3Region: !Ref 's3BucketRegion'
          S3Bucket: !Ref 's3BucketName'
      Parameters:
        appContainerName: !Ref 'appContainerName'
        application: !Ref 'application'
        applicationSubnet: !Select [3, !Split [',', !GetAtt [Network, Outputs.subnetsA]]]
        appSecurityGroupId: !GetAtt [Dag, Outputs.appSecurityGroupId]
        cost: !Ref 'cost'
        environment: !Ref 'environment'
        group: !Ref 'group'
        restrictedSrcAddress: !Ref 'restrictedSrcAddressApp'
        sshKey: !If [createKeyPair, !GetAtt [Access, Outputs.keyPairName], !Ref 'sshKey']
        staticIp: "10.0.3.4"
        uniqueString: !Ref 'uniqueString'
        vpc: !GetAtt
          - Network
          - Outputs.vpcId
  Bastion:
    Type: 'AWS::CloudFormation::Stack'
    Condition: noPublicIp
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.amazonaws.com/${artifactLocation}modules/bastion/bastion.yaml'
        - S3Region: !Ref 's3BucketRegion'
          S3Bucket: !Ref 's3BucketName'
      Parameters:
        application: !Ref 'application'
        mgmtSubnet: !Join
          - ','
          - - !Select
              - '0'
              - !Split
                - ','
                - !GetAtt
                  - Network
                  - Outputs.subnetsA
        bastionSecurityGroupId: !GetAtt
          - Dag
          - Outputs.bastionSecurityGroupId
        cost: !Ref 'cost'
        createAutoscaleGroup: 'false'
        environment: !Ref 'environment'
        group: !Ref 'group'
        sshKey: !If [createKeyPair, !GetAtt [Access, Outputs.keyPairName], !Ref 'sshKey']
        restrictedSrcAddress: !Ref 'restrictedSrcAddressMgmt'
        uniqueString: !Ref 'uniqueString'
        vpc: !GetAtt
          - Network
          - Outputs.vpcId
  BigipStandalone:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.amazonaws.com/${artifactLocation}modules/bigip-standalone/bigip-standalone.yaml'
        - S3Region: !Ref 's3BucketRegion'
          S3Bucket: !Ref 's3BucketName'
      Parameters:
        allowUsageAnalytics: !Ref 'allowUsageAnalytics'
        bigIpRuntimeInitConfig: !Ref 'bigIpRuntimeInitConfig'
        externalSelfPublicIpId: !GetAtt [Dag, Outputs.bigIpExternalEipAllocationId01]
        externalServicePublicIpIds: !GetAtt [Dag, Outputs.bigIpExternalEipAllocationId02]
        externalSecurityGroupId: !If [2nic, !GetAtt [Dag, Outputs.bigIpExternalSecurityGroup],
          !Ref 'AWS::NoValue']
        externalSelfIp: !If [2nic, "10.0.0.11", !Ref 'AWS::NoValue']
        externalServiceIps: !If [1nic, "10.0.1.101", "10.0.0.101"]
        externalSubnetId: !If [2nic, !Select [0, !Split [',', !GetAtt [Network, Outputs.subnetsA]]],
          !Ref 'AWS::NoValue']
        hostname: !Ref 'bigIpHostname'
        imageId: !If [noCustomImageId, !If [isPaygLicensing, !FindInMap [!FindInMap [
                VERSION, !Ref 'version', REGIONMAP], !Ref 'AWS::Region', !FindInMap [
                AWSBigipThroughput, !Ref 'throughput', !Ref 'bigIpImage']], !FindInMap [
              !FindInMap [VERSION, !Ref 'version', REGIONMAP], !Ref 'AWS::Region',
              AllTwoBootLocations]], !Ref 'bigIpCustomImageId']
        instanceProfile: !If [useBigIpInstanceProfile, !Ref 'bigIpInstanceProfile',
          !If [useSecret, !GetAtt [Access, Outputs.bigIpInstanceProfile], !Ref 'AWS::NoValue']]
        instanceType: !Ref 'bigIpInstanceType'
        internalSecurityGroupId: !If [3nic, !GetAtt [Dag, Outputs.bigIpInternalSecurityGroup],
          !Ref 'AWS::NoValue']
        internalSelfIp: !If [3nic, "10.0.2.11", !Ref 'AWS::NoValue']
        internalSubnetId: !If [3nic, !Select [2, !Split [',', !GetAtt [Network, Outputs.subnetsA]]],
          !Ref 'AWS::NoValue']
        licenseKey: !Ref 'bigIpLicenseKey'
        mgmtPublicIpId: !If [noPublicIp, !Ref 'AWS::NoValue', !GetAtt [Dag, Outputs.bigIpManagementEipAllocationId01]]
        mgmtSecurityGroupId: !GetAtt [Dag, Outputs.bigIpMgmtSecurityGroup]
        mgmtAddress: "10.0.1.11"
        mgmtSubnetId: !Select [1, !Split [',', !GetAtt [Network, Outputs.subnetsA]]]
        numExternalPublicIpAddresses: 2
        numSecondaryPrivateIpAddresses: 1
        secretArn: !If [useSecret, !If [createSecret, !GetAtt [Access, Outputs.secretArn],
            !Ref 'bigIpSecretArn'], !Ref 'AWS::NoValue']
        sshKey: !If [createKeyPair, !GetAtt [Access, Outputs.keyPairName], !Ref 'sshKey']
        uniqueString: !Ref 'uniqueString'
  Dag:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.amazonaws.com/${artifactLocation}modules/dag/dag.yaml'
        - S3Region: !Ref 's3BucketRegion'
          S3Bucket: !Ref 's3BucketName'
      Parameters:
        application: !Ref 'application'
        cost: !Ref 'cost'
        createAppSecurityGroup: 'true'
        createBastionSecurityGroup: !If [noPublicIp, 'true', 'false']
        createExternalSecurityGroup: !If [2nic, 'true', 'false']
        createInternalSecurityGroup: !If [3nic, 'true', 'false']
        environment: !Ref 'environment'
        group: !Ref 'group'
        numberPublicExternalIpAddresses: 2
        numberPublicMgmtIpAddresses: !If [noPublicIp, 0, 1]
        restrictedSrcAddressApp: !Ref 'restrictedSrcAddressApp'
        restrictedSrcAddressMgmt: !Ref 'restrictedSrcAddressMgmt'
        restrictedSrcPort: !If [1nic, 8443, 443]
        uniqueString: !Ref 'uniqueString'
        vpcCidr: 10.0.0.0/16
        vpc: !GetAtt
          - Network
          - Outputs.vpcId
  Network:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.amazonaws.com/${artifactLocation}modules/network/network.yaml'
        - S3Region: !Ref 's3BucketRegion'
          S3Bucket: !Ref 's3BucketName'
      Parameters:
        cost: !Ref 'cost'
        environment: !Ref 'environment'
        group: !Ref 'group'
        numAzs: !Ref 'numAzs'
        numSubnets: !Ref 'numSubnets'
        setPublicSubnet1: !Ref 'provisionPublicIp'
        subnetMask: 24
        uniqueString: !Ref 'uniqueString'
        vpcCidr: 10.0.0.0/16
