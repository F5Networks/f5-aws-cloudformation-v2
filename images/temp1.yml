# Example: AWS Quickstart PAYG Template
aws_payg_quickstart_test_job:
  image: ${ARTIFACTORY_SERVER}/dockerhub-remote/python:3.7-alpine
  stage: sprinkle-tests
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-aws-cloudformation-v2/examples/quickstart/payg/**/*
      - automated-test-scripts/f5-aws-cloudformation-v2/examples/quickstart/payg_byol/**/*
      - examples/quickstart/quickstart.yaml
      - examples/modules/bigip-standalone/bigip-standalone.yaml
      - examples/modules/application/application.yaml
      - examples/modules/bastion/bastion.yaml
      - examples/modules/dag/dag.yaml
      - examples/modules/function/function.yaml
      - examples/modules/network/network.yaml
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-aws-cloudformation-v2/examples/quickstart/payg/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Example: AWS Quickstart BYOL Template
aws_byol_quickstart_test_job:
  image: ${ARTIFACTORY_SERVER}/dockerhub-remote/python:3.7-alpine
  stage: sprinkle-tests
  tags:
    - docker-executor
  only:
    refs:
      - branches
    changes:
      - automated-test-scripts/data/f5-aws-cloudformation-v2/examples/quickstart/byol/**/*
      - automated-test-scripts/f5-aws-cloudformation-v2/examples/quickstart/payg_byol/**/*
      - examples/quickstart/quickstart.yaml
      - examples/modules/bigip-standalone/bigip-standalone.yaml
      - examples/modules/application/application.yaml
      - examples/modules/bastion/bastion.yaml
      - examples/modules/dag/dag.yaml
      - examples/modules/function/function.yaml
      - examples/modules/network/network.yaml
  except:
    refs:
      - schedules
      - triggers
      - pipelines
    variables:
      - $RELEASE_RUNTIME_INIT_TESTS == "true"
      - $CI_COMMIT_MESSAGE =~ /smart:init/
  variables:
    TEST_POLICY: automated-test-scripts/data/f5-aws-cloudformation-v2/examples/quickstart/byol/test_policy.yaml
    STACK_TYPE: dewdrop-preproduction
  script:
    - pip install -r cloud-tools/master-job/requirements.txt
    - cloud-tools/master-job/sprinkler.py --test-plan $TEST_POLICY --token $CI_JOB_TOKEN --branch $CI_COMMIT_REF_NAME --stack-type $STACK_TYPE --project-id $CI_PROJECT_ID
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# end of AWS Template Modules Tests