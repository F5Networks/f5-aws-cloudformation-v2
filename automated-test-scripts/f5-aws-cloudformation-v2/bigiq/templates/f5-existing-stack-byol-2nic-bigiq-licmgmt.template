{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Conditions": {
		"noCustomImageId": {
			"Fn::Equals": [
				"OPTIONAL",
				{
					"Ref": "customImageId"
				}
			]
		}
	},
	"Description": "Template used for short lived internal testing. AWS CloudFormation Template for creating a 2NIC BIG-IQ in an existing VPC. **WARNING** This template creates Amazon EC2 Instances, you will be billed for the AWS resources created by this template.",
	"Mappings": {
		"regionMap": {
			"af-south-1": {
			  "Best": "ami-0ea428151263c271b"
			},
			"ap-east-1": {
			  "Best": "ami-0fb6d2deb18311600"
			},
			"ap-northeast-1": {
			  "Best": "ami-021bdf2167b64f5b0"
			},
			"ap-northeast-2": {
			  "Best": "ami-014ac3d4f49aaa52f"
			},
			"ap-northeast-3": {
			  "Best": "ami-09217743b09c67a8f"
			},
			"ap-south-1": {
			  "Best": "ami-0ebe81038929c3e7f"
			},
			"ap-southeast-1": {
			  "Best": "ami-06c4c002fc57e5357"
			},
			"ap-southeast-2": {
			  "Best": "ami-0f21b51a18a3165d5"
			},
			"ca-central-1": {
			  "Best": "ami-0e5150a4a12d37f35"
			},
			"cn-north-1": {
			  "Best": "ami-0f9aee92e7d9a6724"
			},
			"cn-northwest-1": {
			  "Best": "ami-039021a6108ac4ee4"
			},
			"eu-central-1": {
			  "Best": "ami-07aab01e029999c58"
			},
			"eu-north-1": {
			  "Best": "ami-04791f532d82e3d3a"
			},
			"eu-south-1": {
			  "Best": "ami-0f81c1822e33a742b"
			},
			"eu-west-1": {
			  "Best": "ami-08b8f5825166d9c78"
			},
			"eu-west-2": {
			  "Best": "ami-07adc58001662380a"
			},
			"eu-west-3": {
			  "Best": "ami-031dccdaa263a1b04"
			},
			"me-south-1": {
			  "Best": "ami-098c034c24486a5b8"
			},
			"sa-east-1": {
			  "Best": "ami-0621c79d90d380f61"
			},
			"us-east-1": {
			  "Best": "ami-0cc75e62718c469e6"
			},
			"us-east-2": {
			  "Best": "ami-071e6892e09b477e2"
			},
			"us-gov-east-1": {
			  "Best": "ami-008ee4941fea2e634"
			},
			"us-gov-west-1": {
			  "Best": "ami-036fa8b4ddd6a3ac4"
			},
			"us-west-1": {
			  "Best": "ami-0eac67f11aa63be3a"
			},
			"us-west-2": {
			  "Best": "ami-0bc4ac79873f415a5"
			}
		}
	},
	"Metadata": {
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [{
					"Label": {
						"default": "NETWORKING CONFIGURATION"
					},
					"Parameters": [
						"Vpc",
						"managementSubnetAz1",
						"subnet1Az1",
						"availabilityZone1"
					]
				},
				{
					"Label": {
						"default": "INSTANCE CONFIGURATION"
					},
					"Parameters": [
						"customImageId",
						"instanceType",
						"licenseKey1",
						"licensePoolKeys",
						"regPoolKeys",
						"managementGuiPort",
						"sshKey",
						"restrictedSrcAddressMgmt",
						"restrictedSrcAddressApp",
						"ntpServer",
						"timezone"
					]
				},
				{
					"Label": {
						"default": "TAGS"
					},
					"Parameters": [
						"application",
						"environment",
						"group",
						"owner",
						"costcenter"
					]
				},
				{

				},
				{
					"Label": {
						"default": "TEMPLATE ANALYTICS"
					},
					"Parameters": [
						"allowUsageAnalytics"
					]
				}
			],
			"ParameterLabels": {
				"Vpc": {
					"default": "VPC"
				},
				"allowUsageAnalytics": {
					"default": "Send Anonymous Statistics to F5"
				},
				"application": {
					"default": "Application"
				},
				"availabilityZone1": {
					"default": "Availability Zone 1"
				},
				"costcenter": {
					"default": "Cost Center"
				},
				"customImageId": {
					"default": "Custom Image Id"
				},
				"environment": {
					"default": "Environment"
				},
				"group": {
					"default": "Group"
				},
				"instanceType": {
					"default": "AWS Instance Size"
				},
				"licenseKey1": {
					"default": "BIG-IQ License Key 1"
				},				
				"licensePoolKeys": {
					"default": "BIG-IP License Pool"
				},
				"regPoolKeys": {
					"default": "BIG-IP Reg Key Pool"
				},
				"managementGuiPort": {
					"default": "Management Port"
				},
				"managementSubnetAz1": {
					"default": "Management Subnet AZ1"
				},
				"ntpServer": {
					"default": "NTP Server"
				},
				"owner": {
					"default": "Owner"
				},
				"restrictedSrcAddressMgmt": {
					"default": "Source Address(es) for Management Access"
				},
				"restrictedSrcAddressApp": {
					"default": "Source Address(es) for internal Management Access"
				},
				"sshKey": {
					"default": "SSH Key"
				},
				"subnet1Az1": {
					"default": "Subnet1 in AZ1"
				},
				"timezone": {
					"default": "Timezone (Olson)"
				}
			}
		},
		"Version": "3.3.0-r12s2"
	},
	"Outputs": {
		"device1InternalInterfacePrivateIp": {
			"Description": "Internally routable IP of the public interface on the instance",
			"Value": {
				"Fn::GetAtt": [
					"device1subnet1Az1Interface",
					"PrimaryPrivateIpAddress"
				]
			}
		},
		"device1InstanceId": {
			"Description": "Instance Id of the instance in Amazon",
			"Value": {
				"Ref": "device1Instance"
			}
		},
		"device1ManagementEipAddress": {
			"Description": "IP address of the management port on the instance",
			"Value": {
				"Ref": "device1ManagementEipAddress"
			}
		},
		"device1ManagementInterface": {
			"Description": "Management interface ID on the instance",
			"Value": {
				"Ref": "device1ManagementInterface"
			}
		},
		"device1ManagementInterfacePrivateIp": {
			"Description": "Internally routable IP of the management interface on the instance",
			"Value": {
				"Fn::GetAtt": [
					"device1ManagementInterface",
					"PrimaryPrivateIpAddress"
				]
			}
		},
		"device1Url": {
			"Description": "Management GUI",
			"Value": {
				"Fn::Join": [
					"", [
						"https://",
						{
							"Fn::GetAtt": [
								"device1Instance",
								"PublicIp"
							]
						}
					]
				]
			}
		},
		"device1subnet1Az1EipAddress": {
			"Description": "Public IP address assigned to internal interface",
			"Value": {
				"Ref": "device1subnet1Az1EipAddress"
			}
		},
		"device1subnet1Az1Interface": {
			"Description": "Private interface Id on the instance",
			"Value": {
				"Ref": "device1subnet1Az1Interface"
			}
		},
		"availabilityZone1": {
			"Description": "Availability Zone",
			"Value": {
				"Fn::GetAtt": [
					"device1Instance",
					"AvailabilityZone"
				]
			}
		},
		"deviceManagementSecurityGroup": {
			"Description": "Management Security Group",
			"Value": {
				"Ref": "deviceManagementSecurityGroup"
			}
		},
		"deviceInternalSecurityGroup": {
			"Description": "Internal Security Group",
			"Value": {
				"Ref": "deviceInternalSecurityGroup"
			}
		}
	},
	"Parameters": {
		"Vpc": {
			"ConstraintDescription": "This must be an existing VPC within the working region.",
			"Type": "AWS::EC2::VPC::Id"
		},
		"allowUsageAnalytics": {
			"AllowedValues": [
				"Yes",
				"No"
			],
			"Default": "Yes",
			"Description": "This deployment can send anonymous statistics to F5 to help us determine how to improve our solutions. If you select **No** statistics are not sent.",
			"Type": "String"
		},
		"application": {
			"Default": "f5app",
			"Description": "Name of the Application Tag",
			"Type": "String"
		},
		"costcenter": {
			"Default": "f5costcenter",
			"Description": "Name of the Cost Center Tag",
			"Type": "String"
		},
		"customImageId": {
			"ConstraintDescription": "Must be a valid AMI Id",
			"Default": "OPTIONAL",
			"Description": "If you would like to deploy using a custom image, provide the AMI Id.  **Note**: Unless specifically required, leave the default of **OPTIONAL**",
			"MaxLength": 255,
			"MinLength": 1,
			"Type": "String"
		},
		"environment": {
			"Default": "f5env",
			"Description": "Name of the Environment Tag",
			"Type": "String"
		},
		"group": {
			"Default": "f5group",
			"Description": "Name of the Group Tag",
			"Type": "String"
		},
		"instanceType": {
			"AllowedValues": [
				"m4.xlarge",
				"m4.2xlarge",
				"m4.4xlarge"
			],
			"ConstraintDescription": "Must be a valid EC2 instance type for the instance",
			"Default": "m4.2xlarge",
			"Description": "Size of the F5 Instance",
			"Type": "String"
		},
		"licenseKey1": {
			"AllowedPattern": "([a-zA-Z0-9]{3,9}-[a-zA-Z0-9]{3,9}-[a-zA-Z0-9]{3,9}-[a-zA-Z0-9]{3,9}-[a-zA-Z0-9]{3,9})",
			"ConstraintDescription": "Verify your F5 BYOL registration key.",
			"Description": "F5 BIG-IQ license manager registration key",
			"MaxLength": "255",
			"MinLength": "1",
			"Type": "String"
		},
		"licensePoolKeys": {
			"ConstraintDescription": "Verify your F5 BIG-IQ BIG-IP pool registration key.",
			"Description": "Enter a pool name and registration key using the format of name:key. Leave Do_Not_Create if you do not want to create a licensing pool on BIG-IQ at this time.",
			"MaxLength": "255",
			"MinLength": "1",
			"Type": "String",
			"Default": "Do_Not_Create"
		},
		"regPoolKeys": {
			"ConstraintDescription": "Verify your F5 BIG-IQ pool BIG-IP registration keys.",
			"Description": "Enter a pool name and a list of individual BIG-IP registration keys in the format of name:key,key,key. Leave Do_Not_Create if you do not want to create a reg key pool on BIG-IQ at this time.",
			"MaxLength": "255",
			"MinLength": "1",
			"Type": "String",
			"Default": "Do_Not_Create"
		},
		"managementSubnetAz1": {
			"ConstraintDescription": "The subnet ID must be within an existing VPC",
			"Description": "Management Subnet ID",
			"Type": "AWS::EC2::Subnet::Id"
		},
		"ntpServer": {
			"Default": "0.pool.ntp.org",
			"Description": "NTP server for this implementation",
			"Type": "String"
		},
		"owner": {
			"Default": "f5owner",
			"Description": "Name of the Owner Tag",
			"Type": "String"
		},
		"restrictedSrcAddressMgmt": {
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x.",
			"Description": " The IP address range used to SSH and access management GUI on the EC2 instances",
			"MaxLength": "18",
			"MinLength": "9",
			"Type": "String"
		},
		"restrictedSrcAddressApp": {
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x.",
			"Description": " The IP address range that can be used to access BIG-IQ on the specified internal network via port 443.",
			"MaxLength": "18",
			"MinLength": "9",
			"Type": "String"
		},
		"sshKey": {
			"Description": "EC2 KeyPair to enable SSH access to the instance",
			"Type": "AWS::EC2::KeyPair::KeyName"
		},
		"subnet1Az1": {
			"ConstraintDescription": "The subnet ID must be within an existing VPC",
			"Description": "Private or Internal subnet",
			"Type": "AWS::EC2::Subnet::Id"
		},
		"timezone": {
			"Default": "UTC",
			"Description": "Olson timezone string from /usr/share/zoneinfo",
			"Type": "String"
		}	
	},
	"Resources": {
		"device1Instance": {
			"Metadata": {
				"AWS::CloudFormation::Init": {
					"config": {
						"commands": {
							"init": {
								"command": {
									"Fn::Join": [
										"", [
											"mkdir -p /var/log/cloud/aws;cat /config/cloud/passEncoded | /usr/bin/base64 -d > /config/cloud/pass.json && chmod +x /config/cloud/pass.json;cat /config/cloud/bigiqConfigEncoded | /usr/bin/base64 -d > /config/cloud/bigiq_config.py && chmod +x /config/cloud/bigiq_config.py;masterKey=$(cat /config/cloud/pass.json | jq -r .masterPassphrase);",
											"until tmsh show sys mcp-state field-fmt | grep -q running; do echo System Not Ready, wait 10 sec;sleep 10;done; echo System running &>> /var/log/cloud/aws/install.log;",
											"passWord=",
											{
												"Fn::Base64": {"Ref": "AWS::StackName"}
											},
											";",
											"tmsh modify auth user admin password $passWord &>> /var/log/cloud/aws/install.log;",
											"echo waiting 3 min;sleep 120 &>> /var/log/cloud/aws/install.log;",
											"/config/cloud/bigiq_config.py --licensekey ",
											{
												"Ref": "licenseKey1"
											},
											" --ntp_servers ",
											{
												"Ref": "ntpServer"
											},
											" --timezone ",
											{
												"Ref": "timezone"
											},
											" --masterkey $masterKey",
											" --password $passWord",
											" --utility ",
											{
												"Ref": "licensePoolKeys"
											},
											"&>> /var/log/cloud/aws/install.log &"
										]
									]
								}
							}
						},
						"files": {
							"/config/cloud/bigiqConfigEncoded": {
								"group": "root",
								"mode": "000400",
								"owner": "root",
								"content": {
									"Fn::Join": [
										"", [
											"IyEgL3Vzci9sb2NhbC9iaW4vcHl0aG9uMi43CgppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHRpbWUKaW1wb3J0IGFyZ3BhcnNlCmltcG9ydCBvcwoKIyB1c2FnZTogYmlnaXEtY29uZmlnLnB5IFstaF0KI1stLWxpY2Vuc2VrZXkgTElDRU5TRUtFWV0KI1stLW1hc3RlcmtleSBNQVNURVJLRVldCiNbLS1wZXJzb25hbGl0eSBQRVJTT05BTElUWV0gWy0taG9zdG5hbWUgSE9TVE5BTUVdCiNbLS1tYW5hZ2VtZW50SXBBZGRyZXNzIE1BTkFHRU1FTlRJUEFERFJFU1NdCiNbLS1tYW5hZ2VtZW50Um91dGVBZGRyZXNzIE1BTkFHRU1FTlRST1VURUFERFJFU1NdCiNbLS1kaXNjb3ZlcnlBZGRyZXNzIERJU0NPVkVSWUFERFJFU1NdCiNbLS10aW1lem9uZSBUSU1FWk9ORV0KI1stLW50cF9zZXJ2ZXJzIE5UUF9TRVJWRVJTIFtOVFBfU0VSVkVSUyAuLi5dXQojWy0tZG5zX3NlcnZlcnMgRE5TX1NFUlZFUlMgW0ROU19TRVJWRVJTIC4uLl1dCiNbLS11c2VyIFVTRVJdCiNbLS1wYXNzd29yZCBQQVNTV09SRF0KI1stLXV0aWxpdHkgVVRJTElUWSBMSUNFTlNFS0VZXQoKY2xhc3MgU2V0dXA6CgogICAgQkFTRV9VUkw9Imh0dHA6Ly9sb2NhbGhvc3Q6ODEwMCIKICAgIAogICAgZGVmIGdldF9hcmd1bWVudHMoc2VsZik6CiAgICAgICAgcGFyc2VyID0gYXJncGFyc2UuQXJndW1lbnRQYXJzZXIoZGVzY3JpcHRpb249J1NldHVwIGEgQklHLUlRIGluIG9uZSBjb21tYW5kJykKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWxpY2Vuc2VrZXkiLCB0eXBlPXN0ciwgaGVscD0iVGhlIGxpY2Vuc2Uga2V5IikKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW1hc3RlcmtleSIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgbWFzdGVya2V5IHBhc3NwaHJhc2UiLCBkZWZhdWx0PSJUaGlzaXN0aGVtYXN0ZXJrZXkjMTIzNCIpCiAgICAgICAgcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1wZXJzb25hbGl0eSIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgc3lzdGVtIHBlcnNvbmFsaXR5IHtiaWdfaXEsIGxvZ2dpbmdfbm9kZX0iLCBkZWZhdWx0PSJiaWdfaXEiKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0taG9zdG5hbWUiLCB0eXBlPXN0ciwgaGVscD0iVGhlIHN5c3RlbSBob3N0bmFtZSIsIGRlZmF1bHQ9ImJpZ2lxMS5jb20iKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tbWFuYWdlbWVudElwQWRkcmVzcyIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgbWFuYWdlbWVudCBJUCBhZGRyZXNzIGVnLiAxMC4xNDUuMS4xLzE2IiwgZGVmYXVsdD1Ob25lKQogICAgICAgICNwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW1hbmFnZW1lbnRSb3V0ZUFkZHJlc3MiLCB0eXBlPXN0ciwgaGVscD0iVGhlIG1hbmFnZW1lbnQgcm91dGUgYWRkcmVzcyBlZy4gMTAuMTQ1LjEuMSIsIGRlZmF1bHQ9Tm9uZSkKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWRpc2NvdmVyeUFkZHJlc3MiLCB0eXBlPXN0ciwgaGVscD0iVGhlIGRpc2NvdmVyeSBhZGRyZXNzIGVnLiAxMC4xNDUuMS4xIiwgZGVmYXVsdD1Ob25lKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tdGltZXpvbmUiLCB0eXBlPXN0ciwgaGVscD0iVGhlIHN5c3RlbSB0aW1lem9uZSIsIGRlZmF1bHQ9IkFtZXJpY2EvTG9zX0FuZ2VsZXMiKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tdXNlciIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgYWRtaW4gdXNlcm5hbWUiLCBkZWZhdWx0PSJhZG1pbiIpCiAgICAgICAgcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1wYXNzd29yZCIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgYWRtaW4gcGFzc3dvcmQiLCBkZWZhdWx0PSJhZG1pbiIpCiAgICAgICAgcGFyc2VyLmFkZF9hcmd1bWVudCgKICAgICAgICAgICAgIi0tbnRwX3NlcnZlcnMiLAogICAgICAgICAgICB0eXBlPXN0ciwKICAgICAgICAgICAgbmFyZ3M9IisiLAogICAgICAgICAgICBoZWxwPSJOVFAgc2VydmVycyBhcyBhIGxpc3QsIGVnIC0tbnRwLXNlcnZlcnMgdGltZS5uaXN0LmdvdiB0aW1lLm1pY3Jvc29mdC5jb20iLAogICAgICAgICAgICBkZWZhdWx0PVsidGltZS5uaXN0LmdvdiJdCiAgICAgICAgKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoCiAgICAgICAgICAgICItLWRuc19zZXJ2ZXJzIiwKICAgICAgICAgICAgdHlwZT1zdHIsCiAgICAgICAgICAgIG5hcmdzPSIrIiwKICAgICAgICAgICAgaGVscD0iRE5TIHNlcnZlcnMgYXMgYSBsaXN0LCBlZyAtLWRucy1zZXJ2ZXJzIDguOC40LjQgOC44LjguOCA5LjkuOS45IiwKICAgICAgICAgICAgZGVmYXVsdD1bIjguOC44LjgiXQogICAgICAgICkKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItLXV0aWxpdHkiLCB0eXBlPXN0ciwgaGVscD0iVXRpbGl0eSBMaWNlbnNlIEtleSIpCiAgICAgICAgcmV0dXJuIHBhcnNlci5wYXJzZV9hcmdzKCkKCiAgICBkZWYgYXV0aChzZWxmLCB1c2VyLCBwYXNzd29yZCk6CiAgICAgICAgc2VsZi5zZXNzaW9uID0gcmVxdWVzdHMuc2Vzc2lvbigpCiAgICAgICAgc2VsZi5zZXNzaW9uLmF1dGggPSAoc3RyKHVzZXIpLCBzdHIocGFzc3dvcmQpKQoKICAgIGRlZiB3YWl0X2Zvcl9zZXR1cF9tb2RlKHNlbGYpOgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHByaW50KCJXYWl0aW5nIGZvciBzZXR1cCBtb2RlIikKICAgICAgICAgICAgdGltZS5zbGVlcCg1KQoKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLmdldChTZXR1cC5CQVNFX1VSTCArICIvaW5mby9zeXN0ZW0iKQoKICAgICAgICAgICAgaWYgcmVzdWx0LnN0YXR1c19jb2RlICE9IDIwMDoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICByZXN1bHRfanNvbiA9IHJlc3VsdC5qc29uKCkKCiAgICAgICAgICAgIGlmIHJlc3VsdF9qc29uLmdldCgiYXZhaWxhYmxlIikgYW5kIHJlc3VsdF9qc29uLmdldCgiaXNTZXR1cGQiKToKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgZGVmIHNldF9saWNlbnNlKHNlbGYsIGxpY2Vuc2Vfa2V5KToKICAgICAgICBpZiBub3QgbGljZW5zZV9rZXk6CiAgICAgICAgICAgIHByaW50KCJObyBsaWNlbnNlIHByb3ZpZGVkLCBza2lwcGluZyBsaWNlbnNpbmciKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgcHJpbnQoIlNldHRpbmcgbGljZW5zZSB0byAiICsgc3RyKGxpY2Vuc2Vfa2V5KSkKCiAgICAgICAgaWYgbGljZW5zZV9rZXkgPT0gInNraXBMaWNlbnNlOnRydWUiOgogICAgICAgICAgICByZXN1bHQgPSBzZWxmLnNlc3Npb24ucG9zdCgKICAgICAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL2xpY2Vuc2UiLAogICAgICAgICAgICAgICAganNvbj17CiAgICAgICAgICAgICAgICAgICAgImxpY2Vuc2VUZXh0IjogInNraXBMaWNlbnNlOnRydWUiCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICByZXN1bHQucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgICAgIHJlc3VsdF9ib2R5ID0gcmVzdWx0Lmpzb24oKQogICAgICAgICAgICBwcmludChyZXN1bHRfYm9keSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXN1bHQgPSBzZWxmLnNlc3Npb24ucG9zdCgKICAgICAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL2xpY2Vuc2UvYWN0aXZhdGUiLAogICAgICAgICAgICAgICAganNvbj17CiAgICAgICAgICAgICAgICAgICAgImJhc2VSZWdLZXkiOiBsaWNlbnNlX2tleSwKICAgICAgICAgICAgICAgICAgICAiYWRkT25LZXlzIjpbXSwKICAgICAgICAgICAgICAgICAgICAiYWN0aXZhdGlvbk1ldGhvZCI6IkFVVE9NQVRJQyIKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHJlc3VsdC5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICAgICAgcmVzdWx0X2JvZHkgPSByZXN1bHQuanNvbigpCiAgICAgICAgICAgIHByaW50KHJlc3VsdF9ib2R5KQogICAgICAgICAgICBpZiAiTkVFRF9FVUxBX0FDQ0VQVCIgaW4gcmVzdWx0X2JvZHkuZ2V0KCJzdGF0dXMiKToKICAgICAgICAgICAgICAgIHByaW50KCJBY2NlcHRpbmcgRVVMQSIpCgogICAgICAgICAgICAgICAgYWNjZXB0X2V1bGFfYm9keSA9IHsKICAgICAgICAgICAgICAgICAgICAiYmFzZVJlZ0tleSI6IGxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgICAgICJkb3NzaWVyIjogcmVzdWx0X2JvZHkuZ2V0KCJkb3NzaWVyIiksCiAgICAgICAgICAgICAgICAgICAgImV1bGFUZXh0IjogcmVzdWx0X2JvZHkuZ2V0KCJldWxhVGV4dCIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHQgPSBzZWxmLnNlc3Npb24ucG9zdCgKICAgICAgICAgICAgICAgICAgICBTZXR1cC5CQVNFX1VSTCArICIvbWdtdC9zZXR1cC9saWNlbnNlL2FjY2VwdC1ldWxhIiwKICAgICAgICAgICAgICAgICAgICBqc29uPWFjY2VwdF9ldWxhX2JvZHkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHJlc3VsdC5yYWlzZV9mb3Jfc3RhdHVzKCkKCiAgICAgICAgcHJpbnQoIlNhdmluZyBsaWNlbnNlIHRvIHNlcnZpY2UuY29uZmlnLmpzb24iKQogICAgICAgIHNlbGYuc2Vzc2lvbi5wb3N0KAogICAgICAgICAgICBTZXR1cC5CQVNFX1VSTCArICIvbWdtdC9zZXR1cC9saWNlbnNlIiwKICAgICAgICAgICAganNvbj17CiAgICAgICAgICAgICAgICAibGljZW5zZVRleHQiOiByZXN1bHQuanNvbigpLmdldCgibGljZW5zZVRleHQiKQogICAgICAgICAgICB9KQoKICAgIGRlZiBzZXRfbWFzdGVya2V5KHNlbGYsIG1hc3RlcmtleSk6CiAgICAgICAgcHJpbnQoIlNldHRpbmcgbWFzdGVyIGtleSB0byAiICsgc3RyKG1hc3RlcmtleSkpCiAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLnBvc3QoCiAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL21hc3RlcmtleSIsCiAgICAgICAgICAgIGpzb249ewogICAgICAgICAgICAgICAgInBhc3NwaHJhc2UiOiBtYXN0ZXJrZXkKICAgICAgICAgICAgfSkKICAgICAgICByZXN1bHQucmFpc2VfZm9yX3N0YXR1cygpCgogICAgZGVmIHNldF9wZXJzb25hbGl0eShzZWxmLCBwZXJzb25hbGl0eSk6CiAgICAgICAgcHJpbnQoIlNldHRpbmcgcGVyc29uYWxpdHkgdG8gIiArIHN0cihwZXJzb25hbGl0eSkpCiAgICAgICAgc2VsZi5zZXNzaW9uLnBvc3QoCiAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL3BlcnNvbmFsaXR5IiwganNvbj17ICJzeXN0ZW1QZXJzb25hbGl0eSI6IHBlcnNvbmFsaXR5IH0KICAgICAgICApLnJhaXNlX2Zvcl9zdGF0dXMoKQoKICAgIGRlZiBhZGRyZXNzZXNfYXJlX3ZhbGlkKHNlbGYsIGFkZHJlc3Nlcyk6CiAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgYWRkcmVzc2VzIGlzIG5vdCBOb25lIGFuZAogICAgICAgICAgICBhZGRyZXNzZXMuZ2V0KCJob3N0bmFtZSIpIGFuZAogICAgICAgICAgICBhZGRyZXNzZXMuZ2V0KCJtYW5hZ2VtZW50SXBBZGRyZXNzIikgYW5kCiAgICAgICAgICAgICNhZGRyZXNzZXMuZ2V0KCJtYW5hZ2VtZW50Um91dGVBZGRyZXNzIikgYW5kCiAgICAgICAgICAgIGFkZHJlc3Nlcy5nZXQoImRpc2NvdmVyeUFkZHJlc3MiKQogICAgICAgICkKCiAgICBkZWYgc2V0X2FkZHJlc3NlcyhzZWxmLCBhZGRyZXNzZXMpOgogICAgICAgIGlmIG5vdCBzZWxmLmFkZHJlc3Nlc19hcmVfdmFsaWQoYWRkcmVzc2VzKToKICAgICAgICAgICAgcHJpbnQoIk1pc3NpbmcgYWRkcmVzcyBhcmd1bWVudHMsIHNraXBwaW5nIGZvciBub3csIHRoaXMgaXNuJ3QgY3JpdGljYWwgdG8gc2V0dXAiKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgcHJpbnQoIlNldHRpbmcgYWRkcmVzc2VzIHRvIikKICAgICAgICBib2R5ID0gewogICAgICAgICAgICAgICAgImhvc3RuYW1lIjphZGRyZXNzZXMuZ2V0KCJob3N0bmFtZSIpLAogICAgICAgICAgICAgICAgIm1hbmFnZW1lbnRJcEFkZHJlc3MiOmFkZHJlc3Nlcy5nZXQoIm1hbmFnZW1lbnRJcEFkZHJlc3MiKSwKICAgICAgICAgICAgICAgICMibWFuYWdlbWVudFJvdXRlQWRkcmVzcyI6YWRkcmVzc2VzLmdldCgibWFuYWdlbWVudFJvdXRlQWRkcmVzcyIpLAogICAgICAgICAgICAgICAgImRpc2NvdmVyeUFkZHJlc3MiOmFkZHJlc3Nlcy5nZXQoImRpc2NvdmVyeUFkZHJlc3MiKQogICAgICAgICAgICB9CiAgICAgICAgcHJpbnQoYm9keSkKCiAgICAgICAgc2VsZi5zZXNzaW9uLnBvc3QoCiAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL2FkZHJlc3MiLAogICAgICAgICAgICBqc29uPWJvZHkpLnJhaXNlX2Zvcl9zdGF0dXMoKQoKICAgIGRlZiBzZXRfc2VydmljZXMoc2VsZiwgbnRwX3NlcnZlcnMsIHRpbWV6b25lLCBkbnNfc2VydmVycyk6CiAgICAgICAgcHJpbnQoIlNldHRpbmcgTlRQIHNlcnZlcnMiKQogICAgICAgIHNlbGYuc2Vzc2lvbi5wb3N0KFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL250cCIsIGpzb249eyAic2VydmVycyI6IG50cF9zZXJ2ZXJzLCAidGltZXpvbmUiOiB0aW1lem9uZSB9KS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICBwcmludCgiU2V0dGluZyBETlMgc2VydmVycyIpCiAgICAgICAgc2VsZi5zZXNzaW9uLnBvc3QoU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvZG5zIiwganNvbj17ICJzZXJ2ZXJzIjogZG5zX3NlcnZlcnMsICJzZWFyY2giOiBbICJsb2NhbGhvc3QiIF0gfSkucmFpc2VfZm9yX3N0YXR1cygpCgogICAgZGVmIGxhdW5jaF9iaWdpcShzZWxmKToKICAgICAgICBwcmludCgiTGF1bmNoaW5nIEJJRy1JUSIpCiAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLnBvc3QoU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvbGF1bmNoIikKICAgICAgICByZXN1bHQucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgc2tpcCA9IDAKICAgICAgICB0b3AgPSAxMDAKICAgICAgICB0aW1lc3RhbXAgPSByZXN1bHQuanNvbigpLmdldCgiZmlsZVRpbWVzdGFtcCIpCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLmdldCgKICAgICAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL2xhdW5jaC9tb25pdG9yP2RhdGV0aW1lPXtkYXRldGltZX0mdG9wPXt0b3B9JnNraXA9e3NraXB9IgogICAgICAgICAgICAgICAgICAgIC5mb3JtYXQoCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGV0aW1lPXRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9wPXRvcCwKICAgICAgICAgICAgICAgICAgICAgICAgc2tpcD1za2lwCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICApCgogICAgICAgICAgICByZXN1bHRfanNvbiA9IHJlc3VsdC5qc29uKCkKCiAgICAgICAgICAgIGlmIHJlc3VsdF9qc29uLmdldCgic3RhdHVzIikgPT0gIkNPTVBMRVRFIjoKICAgICAgICAgICAgICAgIHByaW50KCJTZXR1cCBjb21wbGV0ZSIpCiAgICAgICAgICAgICAgICBwcmludCgiR2V0IHBnaW5pdCBhbmQgdG9rdVVwZ3JhZGUgc3RhdHVzIHdpdGgiKQogICAgICAgICAgICAgICAgcHJpbnQoInRhaWwgLWYgL3Zhci9sb2cvYm9vdHN0cmFwLSIgKyB0aW1lc3RhbXAgKyAiLioiKQogICAgICAgICAgICAgICAgcHJpbnQoIkdldCByZXN0amF2YWQgc3RhdHVzIHdpdGgiKQogICAgICAgICAgICAgICAgcHJpbnQoInJlc3RjdXJsIC9zaGFyZWQvc3lzdGVtLXN0YXJ0ZWQiKQogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGpzb24gPSByZXN1bHQuanNvbigpCgogICAgICAgICAgICBsaW5lcyA9IHJlc3VsdC5qc29uKCkuZ2V0KCJsaW5lcyIpCiAgICAgICAgICAgIHNraXAgKz0gbGVuKGxpbmVzKQoKICAgICAgICAgICAgaWYgbGluZXM6CiAgICAgICAgICAgICAgICBwcmludCgiXG4iLmpvaW4obGluZXMpKQoKICAgICAgICAgICAgdGltZS5zbGVlcCgxKQoKICAgIGRlZiBlbmFibGVfYmFzaWNfYXV0aChzZWxmKToKICAgICAgICB3aXRoIG9wZW4oIi9ldGMvYmlnc3RhcnQvc2NyaXB0cy9zZXR1cGQiLCBtb2RlPSJyKyIpIGFzIHNldHVwZF9zY3JpcHQ6CiAgICAgICAgICAgIHByaW50KCJFbmFibGluZyBiYXNpYyBhdXRoIikKICAgICAgICAgICAgZmlsZV9jb250ZW50cyA9IHNldHVwZF9zY3JpcHQucmVhZCgpCiAgICAgICAgICAgIGZpbGVfY29udGVudHMgPSBmaWxlX2NvbnRlbnRzLnJlcGxhY2UoIiNleHBvcnQgQklHSVFfQkFTSUNfQVVUSF9FTkFCTEVEPVRydWUiLCAiZXhwb3J0IEJJR0lRX0JBU0lDX0FVVEhfRU5BQkxFRD1UcnVlIikKICAgICAgICAgICAgc2V0dXBkX3NjcmlwdC5zZWVrKDApCiAgICAgICAgICAgIHNldHVwZF9zY3JpcHQud3JpdGUoZmlsZV9jb250ZW50cykKICAgICAgICAgICAgc2V0dXBkX3NjcmlwdC50cnVuY2F0ZSgpCiAgICAgICAgcHJpbnQoIlJlc3RhcnRpbmcgc2V0dXBkIikKICAgICAgICBzdWJwcm9jZXNzLmNoZWNrX2NhbGwoWyJiaWdzdGFydCIsICJyZXN0YXJ0IiwgInNldHVwZCJdKQoKICAgIGRlZiB3YWl0X2Zvcl9pbml0aWFsX2FjdGl2YXRpb24oc2VsZik6CiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgcHJpbnQoIldhaXRpbmcgZm9yIGluaXRpYWxfYWN0aXZhdGlvbiBjbGllbnQiKQogICAgICAgICAgICB0aW1lLnNsZWVwKDUpCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuc2Vzc2lvbi5nZXQoU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvY20vZGV2aWNlL2xpY2Vuc2luZy9wb29sL2luaXRpYWwtYWN0aXZhdGlvbiIpCiAgICAgICAgICAgIGlmIHJlc3VsdC5zdGF0dXNfY29kZSAhPSAyMDA6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICByZXN1bHRfanNvbiA9IHJlc3VsdC5qc29uKCkKICAgICAgICAgICAgaWYgcmVzdWx0X2pzb24uZ2V0KCJzZWxmTGluayIpID09ICJodHRwczovL2xvY2FsaG9zdC9tZ210L2NtL2RldmljZS9saWNlbnNpbmcvcG9vbC9pbml0aWFsLWFjdGl2YXRpb24iOgogICAgICAgICAgICAgICAgYnJlYWsKCiAgICBkZWYgY3JlYXRlX3V0aWxpdHlfcG9vbChzZWxmLCB1dGlsaXR5KToKICAgICAgICBpZiBub3QgdXRpbGl0eToKICAgICAgICAgICAgcHJpbnQoIk5vIGxpY2Vuc2UgcHJvdmlkZWQsIHNraXBwaW5nIGxpY2Vuc2UgcG9vbCBjcmVhdGlvbiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHByaW50KCJBZGRpbmcgdXRpbGl0eSBsaWNlbnNlICIgKyBzdHIodXRpbGl0eSkpCiAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLnBvc3QoU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvY20vZGV2aWNlL2xpY2Vuc2luZy9wb29sL2luaXRpYWwtYWN0aXZhdGlvbiIsIGpzb249eyJyZWdLZXkiOiB1dGlsaXR5LCAibmFtZSI6ICJwcm9kdWN0aW9uIiwgInN0YXR1cyI6IkFDVElWQVRJTkdfQVVUT01BVElDIn0pCiAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgIHJlc3VsdF9ib2R5ID0gcmVzdWx0Lmpzb24oKQogICAgICAgIHByaW50KHJlc3VsdF9ib2R5KQogICAgCiAgICBkZWYgYWN0aXZhdGVfdXRpbGl0eV9wb29sKHNlbGYsIHV0aWxpdHkpOgogICAgICAgIGlmIG5vdCB1dGlsaXR5OgogICAgICAgICAgICBwcmludCgiTm8gbGljZW5zZSBwcm92aWRlZCwgc2tpcHBpbmcgbGljZW5zZSBwb29sIGFjdGl2YXRpb24iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICByZXN1bHQgPSBzZWxmLnNlc3Npb24uZ2V0KAogICAgICAgICAgICBTZXR1cC5CQVNFX1VSTCArICIvbWdtdC9jbS9kZXZpY2UvbGljZW5zaW5nL3Bvb2wvaW5pdGlhbC1hY3RpdmF0aW9uLyIgKyBzdHIodXRpbGl0eSkKICAgICAgICAgICAgKQogICAgICAgIHJlc3VsdC5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICByZXN1bHRfYm9keSA9IHJlc3VsdC5qc29uKCkKICAgICAgICBldWxhX3RleHQgPSByZXN1bHRfYm9keS5nZXQoImV1bGFUZXh0IikgCiAgICAgICAgaWYgIk5FRURfRVVMQV9BQ0NFUFQiIGluIHJlc3VsdF9ib2R5LmdldCgic3RhdHVzIik6CiAgICAgICAgICAgIHByaW50KCJBY2NlcHRpbmcgRVVMQSIpCiAgICAgICAgICAgIGFjY2VwdF9ldWxhX2JvZHkgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogIkFDVElWQVRJTkdfQVVUT01BVElDX0VVTEFfQUNDRVBURUQiLAogICAgICAgICAgICAgICAgImV1bGFUZXh0IjogZXVsYV90ZXh0CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLnBhdGNoKAogICAgICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvY20vZGV2aWNlL2xpY2Vuc2luZy9wb29sL2luaXRpYWwtYWN0aXZhdGlvbi8iICsgc3RyKHV0aWxpdHkpLAogICAgICAgICAgICAgICAganNvbj1hY2NlcHRfZXVsYV9ib2R5CiAgICAgICAgICAgICkKICAgICAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICByZXN1bHRfYm9keSA9IHJlc3VsdC5qc29uKCkKICAgICAgICAgICAgcHJpbnQocmVzdWx0X2JvZHkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIkV1bGEgYWxyZWFkeSBhY2NlcHRlZCIpCiAgICAgICAgICAgIHByaW50KHJlc3VsdF9ib2R5KQoKICAgIGRlZiB2ZXJpZnlfdXRpbGl0eV9hY3RpdmF0aW9uKHNlbGYsIHV0aWxpdHkpOgogICAgICAgIGlmIG5vdCB1dGlsaXR5OgogICAgICAgICAgICBwcmludCgiTm8gbGljZW5zZSBwcm92aWRlZCwgc2tpcHBpbmcgbGljZW5zZSBwb29sIGFjdGl2YXRpb24gdmVyaWZpY2F0aW9uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLmdldCgKICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvY20vZGV2aWNlL2xpY2Vuc2luZy9wb29sL2luaXRpYWwtYWN0aXZhdGlvbi8iICsgc3RyKHV0aWxpdHkpCiAgICAgICAgICAgICkKICAgICAgICByZXN1bHQucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgcmVzdWx0X2JvZHkgPSByZXN1bHQuanNvbigpCiAgICAgICAgaSA9IDAKICAgICAgICB3aGlsZSAiUkVBRFkiIG5vdCBpbiByZXN1bHRfYm9keS5nZXQoInN0YXR1cyIpIGFuZCBpIDwgMTIwOgogICAgICAgICAgICBpKz0xCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuc2Vzc2lvbi5nZXQoCiAgICAgICAgICAgICAgICBTZXR1cC5CQVNFX1VSTCArICIvbWdtdC9jbS9kZXZpY2UvbGljZW5zaW5nL3Bvb2wvaW5pdGlhbC1hY3RpdmF0aW9uLyIgKyBzdHIodXRpbGl0eSkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICByZXN1bHRfYm9keSA9IHJlc3VsdC5qc29uKCkKICAgICAgICAgICAgcHJpbnQoIkxpY2Vuc2Ugbm90IHJlYWR5OiIgKyBzdHIocmVzdWx0X2JvZHkuZ2V0KCJzdGF0dXMiKSkpCiAgICAgICAgICAgIHByaW50KCJXYWl0aW5nIGZvciA1IHNlY29uZHMiKQogICAgICAgICAgICB0aW1lLnNsZWVwKDUpCiAgICAgICAgaWYgaSA9PSAxMjA6CiAgICAgICAgICAgIHByaW50KCJNQVggdHJpZXMgcmVhY2hlZCwgZXhpdGluZyIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIkxpY2Vuc2UgcmVhZHk6IiArIHN0cihyZXN1bHRfYm9keSkpCgogICAgZGVmIHZlcmlmeV91dGlsaXR5X2tleShzZWxmLCB1dGlsaXR5KToKICAgICAgICBpZiBub3QgdXRpbGl0eToKICAgICAgICAgICAgcHJpbnQoIk5vIGxpY2Vuc2UgcHJvdmlkZWQsIHNraXBwaW5nIGxpY2Vuc2UgcG9vbCBhY3RpdmF0aW9uIHZlcmlmaWNhdGlvbiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHJlc3VsdCA9IHNlbGYuc2Vzc2lvbi5nZXQoCiAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L2NtL2RldmljZS9saWNlbnNpbmcvcG9vbC91dGlsaXR5L2xpY2Vuc2VzIgogICAgICAgICAgICApCiAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgIHJlc3VsdF9ib2R5ID0gcmVzdWx0Lmpzb24oKQogICAgICAgIGkgPSAwCiAgICAgICAgd2hpbGUgIlJFQURZIiBub3QgaW4gcmVzdWx0X2JvZHkuZ2V0KCJpdGVtcyIpWzBdLmdldCgic3RhdHVzIikgYW5kIGkgPCAxMjA6CiAgICAgICAgICAgIGlmICJBQ1RJVkFUSU9OX0ZBSUxFRF9PRkZFUklORyIgaW4gcmVzdWx0X2JvZHkuZ2V0KCJpdGVtcyIpWzBdLmdldCgic3RhdHVzIik6CiAgICAgICAgICAgICAgICBwcmludCgiT2ZmZXJpbmcgZmFpbGVkIGFjdGl2YXRpb24iKQogICAgICAgICAgICAgICAgc2VsZi50b3VjaCgiL2NvbmZpZy9jbG91ZC9hY3RpdmF0aW9uX2ZhaWxlZCIpCiAgICAgICAgICAgIGkrPTEKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLmdldCgKICAgICAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L2NtL2RldmljZS9saWNlbnNpbmcvcG9vbC91dGlsaXR5L2xpY2Vuc2VzIgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICByZXN1bHQucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgICAgIHJlc3VsdF9ib2R5ID0gcmVzdWx0Lmpzb24oKQogICAgICAgICAgICBwcmludCgiTGljZW5zZSBrZXkgbm90IHJlYWxseSByZWFkeToiICsgc3RyKHJlc3VsdF9ib2R5LmdldCgiaXRlbXMiKVswXS5nZXQoInN0YXR1cyIpKSkKICAgICAgICAgICAgcHJpbnQoIldhaXRpbmcgZm9yIDEwIHNlY29uZHMgZm9yIGxpY2Vuc2UgdG8gcmVhbGx5IGJlIHJlYWR5IikKICAgICAgICAgICAgdGltZS5zbGVlcCgxMCkKICAgICAgICBpZiBpID09IDEyMDoKICAgICAgICAgICAgcHJpbnQoIk1BWCB0cmllcyByZWFjaGVkLCBleGl0aW5nIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCgiTGljZW5zZSByZWFsbHkgcmVhZHk6IiArIHN0cihyZXN1bHRfYm9keSkpCiAgICAgICAgICAgIHNlbGYudG91Y2goIi9jb25maWcvY2xvdWQvY29uZmlnX2NvbXBsZXRlIikKCiAgICBkZWYgdG91Y2goc2VsZiwgcGF0aCk6CiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICdhJyk6CiAgICAgICAgICAgIG9zLnV0aW1lKHBhdGgsIE5vbmUpCgogICAgZGVmIG1haW4oc2VsZik6CiAgICAgICAgYXJncyA9IHNlbGYuZ2V0X2FyZ3VtZW50cygpCiAgICAgICAgcHJpbnQoIlJ1bm5pbmcgQklHSVEgY29uZmlndXJhdGlvbiB3aXRoIHRoZXNlIGFyZ3VtZW50cyIpCiAgICAgICAgcHJpbnQoYXJncykKCiAgICAgICAgc2VsZi5lbmFibGVfYmFzaWNfYXV0aCgpICAgICAKICAgICAgICBzZWxmLmF1dGgoYXJncy51c2VyLGFyZ3MucGFzc3dvcmQpCiAgICAgICAgc2VsZi53YWl0X2Zvcl9zZXR1cF9tb2RlKCkKICAgICAgICBzZWxmLnNldF9saWNlbnNlKGFyZ3MubGljZW5zZWtleSkKICAgICAgICBzZWxmLnNldF9tYXN0ZXJrZXkoYXJncy5tYXN0ZXJrZXkpCiAgICAgICAgc2VsZi5zZXRfcGVyc29uYWxpdHkoYXJncy5wZXJzb25hbGl0eSkKICAgICAgICBzZWxmLnNldF9hZGRyZXNzZXMoewogICAgICAgICAgICAgICAgImhvc3RuYW1lIjogYXJncy5ob3N0bmFtZSwKICAgICAgICAgICAgICAgICJtYW5hZ2VtZW50SXBBZGRyZXNzIjogYXJncy5tYW5hZ2VtZW50SXBBZGRyZXNzLAogICAgICAgICAgICAgICAgIyJtYW5hZ2VtZW50Um91dGVBZGRyZXNzIjogYXJncy5tYW5hZ2VtZW50Um91dGVBZGRyZXNzLAogICAgICAgICAgICAgICAgImRpc2NvdmVyeUFkZHJlc3MiOiBhcmdzLmRpc2NvdmVyeUFkZHJlc3MKICAgICAgICAgICAgfSkKICAgICAgICBzZWxmLnNldF9zZXJ2aWNlcyhudHBfc2VydmVycz1hcmdzLm50cF9zZXJ2ZXJzLCB0aW1lem9uZT1hcmdzLnRpbWV6b25lLCBkbnNfc2VydmVycz1hcmdzLmRuc19zZXJ2ZXJzKQogICAgICAgIHNlbGYubGF1bmNoX2JpZ2lxKCkKICAgICAgICB0aW1lLnNsZWVwKDEyMCkKICAgICAgICBzZWxmLmVuYWJsZV9iYXNpY19hdXRoKCkKICAgICAgICBzZWxmLmF1dGgoYXJncy51c2VyLGFyZ3MucGFzc3dvcmQpCiAgICAgICAgc2VsZi53YWl0X2Zvcl9pbml0aWFsX2FjdGl2YXRpb24oKQogICAgICAgIHRpbWUuc2xlZXAoNjApCiAgICAgICAgc2VsZi5jcmVhdGVfdXRpbGl0eV9wb29sKGFyZ3MudXRpbGl0eSkKICAgICAgICB0aW1lLnNsZWVwKDYwKQogICAgICAgIHNlbGYuYWN0aXZhdGVfdXRpbGl0eV9wb29sKGFyZ3MudXRpbGl0eSkKICAgICAgICBzZWxmLnZlcmlmeV91dGlsaXR5X2FjdGl2YXRpb24oYXJncy51dGlsaXR5KQogICAgICAgIHNlbGYudmVyaWZ5X3V0aWxpdHlfa2V5KGFyZ3MudXRpbGl0eSkKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBzZXR1cCA9IFNldHVwKCkKICAgIHNldHVwLm1haW4oKQo="
										]
									]
								}
							},
							"/config/cloud/passEncoded": {
								"group": "root",
								"mode": "000400",
								"owner": "root",
								"content": {
									"Fn::Join": [
										"", [
											"ewogICJtYXN0ZXJQYXNzcGhyYXNlIjogIjM0amtjdm5pMzg5IzQ5NGtjeEBkZmtkaTlIIiwKICAicm9vdCI6ICJyYW5kUGFzczRSb290ISIsCiAgImFkbWluIjogImIxZ0FkbWluUGF6eiIKfQ=="
										]
									]
								}
							}
						}
					}
				}
			},
			"Properties": {
				"BlockDeviceMappings": [{
						"DeviceName": "/dev/xvda",
						"Ebs": {
							"DeleteOnTermination": "true",
							"VolumeType": "gp2"
						}
					},
					{
						"DeviceName": "/dev/xvdb",
						"NoDevice": {

						}
					}
				],
				"ImageId": {
					"Fn::If": [
						"noCustomImageId",
						{
							"Fn::FindInMap": [
								"regionMap",
								{
									"Ref": "AWS::Region"
								},
								"Best"
							]
						},
						{
							"Ref": "customImageId"
						}
					]
				},
				"InstanceType": {
					"Ref": "instanceType"
				},
				"KeyName": {
					"Ref": "sshKey"
				},
				"NetworkInterfaces": [{
						"Description": "Management Interface",
						"DeviceIndex": "0",
						"NetworkInterfaceId": {
							"Ref": "device1ManagementInterface"
						}
					},
					{
						"Description": "Private or Internal Interface",
						"DeviceIndex": "1",
						"NetworkInterfaceId": {
							"Ref": "device1subnet1Az1Interface"
						}
					}
				],
				"Tags": [{
						"Key": "Application",
						"Value": {
							"Ref": "application"
						}
					},
					{
						"Key": "Costcenter",
						"Value": {
							"Ref": "costcenter"
						}
					},
					{
						"Key": "Environment",
						"Value": {
							"Ref": "environment"
						}
					},
					{
						"Key": "Group",
						"Value": {
							"Ref": "group"
						}
					},
					{
						"Key": "Name",
						"Value": {
							"Fn::Join": [
								"", [
									"Instance: ",
									{
										"Ref": "AWS::StackName"
									}
								]
							]
						}
					},
					{
						"Key": "Owner",
						"Value": {
							"Ref": "owner"
						}
					},
					{
						"Key": "Bigiq",
						"Value": {
							"Fn::Join": [
								"", [
									"BIG-IQ: ",
									{
										"Ref": "AWS::StackName"
									}
								]
							]
						}
					}
				],
				"UserData": {
					"Fn::Base64": {
						"Fn::Join": [
							"", [
								"#!/bin/bash\n",
								"/opt/aws/apitools/cfn-init-1.4-24/bin/cfn-init -v -s ",
								{
									"Ref": "AWS::StackId"
								},
								" -r ",
								"device1Instance",
								" --region ",
								{
									"Ref": "AWS::Region"
								},
								"\n"
							]
						]
					}
				}
			},
			"Type": "AWS::EC2::Instance"
		},
		"device1ManagementEipAddress": {
			"Properties": {
				"Domain": "vpc"
			},
			"Type": "AWS::EC2::EIP"
		},
		"device1ManagementEipAssociation": {
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"device1ManagementEipAddress",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "device1ManagementInterface"
				}
			},
			"Type": "AWS::EC2::EIPAssociation"
		},
		"device1subnet1Az1EipAddress": {
			"Properties": {
				"Domain": "vpc"
			},
			"Type": "AWS::EC2::EIP"
		},
		"device1subnet1Az1EipAssociation": {
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"device1subnet1Az1EipAddress",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "device1subnet1Az1Interface"
				}
			},
			"Type": "AWS::EC2::EIPAssociation"
		},
		"device1ManagementInterface": {
			"Properties": {
				"Description": "Management Interface",
				"GroupSet": [{
					"Ref": "deviceManagementSecurityGroup"
				}],
				"SubnetId": {
					"Ref": "managementSubnetAz1"
				}
			},
			"Type": "AWS::EC2::NetworkInterface"
		},
		"device1subnet1Az1Interface": {
			"Properties": {
				"Description": "Private Interface for the the instance",
				"GroupSet": [{
					"Ref": "deviceInternalSecurityGroup"
				}],
				"SubnetId": {
					"Ref": "subnet1Az1"
				}
			},
			"Type": "AWS::EC2::NetworkInterface"
		},
		"deviceManagementSecurityGroup": {
			"Properties": {
				"GroupDescription": "management interface policy",
				"SecurityGroupIngress": [{
						"CidrIp": {
							"Ref": "restrictedSrcAddressMgmt"
						},
						"FromPort": "22",
						"IpProtocol": "tcp",
						"ToPort": "22"
					},
					{
						"CidrIp": {
							"Ref": "restrictedSrcAddressMgmt"
						},
						"FromPort": "443",
						"IpProtocol": "tcp",
						"ToPort": "443"
					}
				],
				"Tags": [{
						"Key": "Application",
						"Value": {
							"Ref": "application"
						}
					},
					{
						"Key": "Costcenter",
						"Value": {
							"Ref": "costcenter"
						}
					},
					{
						"Key": "Environment",
						"Value": {
							"Ref": "environment"
						}
					},
					{
						"Key": "Group",
						"Value": {
							"Ref": "group"
						}
					},
					{
						"Key": "Name",
						"Value": {
							"Fn::Join": [
								"", [
									"Management Security Group:",
									{
										"Ref": "AWS::StackName"
									}
								]
							]
						}
					},
					{
						"Key": "Owner",
						"Value": {
							"Ref": "owner"
						}
					}
				],
				"VpcId": {
					"Ref": "Vpc"
				}
			},
			"Type": "AWS::EC2::SecurityGroup"
		},
		"deviceInternalSecurityGroup": {
			"Properties": {
				"GroupDescription": "internal interface policy",
				"SecurityGroupIngress": [{
						"CidrIp": {
							"Ref": "restrictedSrcAddressApp"
						},
						"FromPort": "443",
						"IpProtocol": "tcp",
						"ToPort": "443"
					}
				],
				"Tags": [{
						"Key": "Application",
						"Value": {
							"Ref": "application"
						}
					},
					{
						"Key": "Costcenter",
						"Value": {
							"Ref": "costcenter"
						}
					},
					{
						"Key": "Environment",
						"Value": {
							"Ref": "environment"
						}
					},
					{
						"Key": "Group",
						"Value": {
							"Ref": "group"
						}
					},
					{
						"Key": "Name",
						"Value": {
							"Fn::Join": [
								"", [
									"Internal Security Group:",
									{
										"Ref": "AWS::StackName"
									}
								]
							]
						}
					},
					{
						"Key": "Owner",
						"Value": {
							"Ref": "owner"
						}
					}
				],
				"VpcId": {
					"Ref": "Vpc"
				}
			},
			"Type": "AWS::EC2::SecurityGroup"
		}
	}
}
